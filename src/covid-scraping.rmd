---
title: 'COVID Scraping'
author: 'Jeffrey Brennan'
output: html_document
editor_options: 
  chunk_output_type: console
knit: (function(inputFile, encoding) {
  rmarkdown::render(inputFile, encoding = encoding, output_dir = "diagnostics/",
                    knit_root_dir = "C:/Users/jeffb/Desktop/Life/personal-projects/COVID") })
---

# SETUP

```{r, echo = FALSE}
# performance analysis 
# source: https://bookdown.org/yihui/rmarkdown-cookbook/time-chunk.html
all_times <- list()  # store the time for each chunk
knitr::knit_hooks$set(time_it = local({
  now <- NULL
  function(before, options) {
    if (before) {
      now <<- Sys.time()
    } else {
      res <- difftime(Sys.time(), now)
      all_times[[options$label]] <<- res
    }
  }
}))
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
knitr::opts_chunk$set(time_it = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(comment = NA)
```

```{r, echo = FALSE}
refactor_version = '3'
```

```{r}
# data manipulation
library(tidyverse)
library(data.table)
library(readxl)
library(writexl)
library(stringr)
library(zoo)

library(lubridate)

library(ggpubr)

# web scraping
library(rvest)
library(jsonlite)
library(glue)
```

```{r}
# Grab every sheet from an excel file and convert to list of dataframes
# https://stackoverflow.com/questions/12945687/read-all-worksheets-in-an-excel-workbook-into-an-r-list-with-data-frames
read_excel_allsheets = function(filename, col_option = TRUE, add_date = FALSE, skip_option = 1) {
    sheets = readxl::excel_sheets(filename)
    x = lapply(sheets, function(X) read_excel(filename, sheet = X,
                                              skip = skip_option,
                                              col_names = col_option, na = '.'))
    names(x) = sheets
    x = lapply(x, as.data.frame)
    
    if (add_date == TRUE) { 
      file_date = str_extract(filename, '\\d.*\\d')
      x = lapply(x, function(z) return(mutate(z, Date = as.Date(file_date))))
    }
    return(x)
}

# set date for writing files
# If before 5 PM EST, then record as last date since DSHS data will not be updated yet
date_out = ifelse((Sys.time() < as.POSIXct(paste0(Sys.Date(), '16:00'), tz = 'America/Chicago')),
                   Sys.Date() - 1,
                   Sys.Date())

# convert numeric sys.date() to yyyy-mm-dd
date_out = as.Date(date_out, origin = '1970-1-1')


Fix_Num_Dates = function(dates) { 
  # TODO: add more checks for different int dates
  clean_dates = as.Date(as.numeric(dates), '1899-12-30')

  if (sum(is.na(clean_dates)) > 0) {
    clean_dates[which(is.na(clean_dates))] = as.Date(clean_dates[which(is.na(clean_dates))], origin = '1970-1-1')
  }
  return(format(clean_dates, '%Y-%m-%d'))
}
  
Fix_Char_Dates = function(dates) { 
  #Matches 2 or 4 digits, separator, 2 or 4 digits, optional separator, optional 2 or 4 digits
  # Coerces all common separators to "-" 
  date_regex = '(\\d{4}|\\d{2}|\\d{1})(\\.|\\-|\\/)(\\d{4}|\\d{2}|\\d{1})?(\\.|\\-|\\/)?(\\d{4}|\\d{2})'
  clean_dates = str_extract(dates, date_regex) %>% str_replace_all(., '\\/|\\.', '\\-')
  
  mdy_dates = which(!is.na(as.Date(clean_dates, format = '%m-%d-%y')))
  md_dates = which(is.na(as.Date(clean_dates, format = '%m-%d-%Y')))
  # if (length(mdy_dates) == length(md_dates)) { 
  #   md_dates = c()
  # }
  

  if (length(md_dates > 0)){
      md_dates_2020 = which(format(as.Date(clean_dates[md_dates], '%m-%d'), '%m') %in% as.character(seq(as.numeric(format(date_out, '%m')) + 1, 12)))
    
    if (length(md_dates_2020) > 0) { 
      clean_dates[md_dates[md_dates_2020]] = paste0('2020-', clean_dates[md_dates[md_dates_2020]])
      clean_dates[md_dates[-md_dates_2020]] = format(as.Date(clean_dates[md_dates[-md_dates_2020]],
                                                             '%m-%d'), '%Y-%m-%d')
    } else { 
      clean_dates[md_dates] = format(as.Date(clean_dates, '%m-%d'), '%Y-%m-%d')
    }
  }
  
  if (length(mdy_dates > 0)) { 
    clean_dates[mdy_dates] = format(as.Date(clean_dates[mdy_dates], '%m-%d-%Y'), '%Y-%m-%d')
  }

  return(clean_dates)
}


Date_Parser = function(raw_date) { 
  numeric_loc = which(!is.na(as.numeric(raw_date)))

    if (length(numeric_loc) == 0){
      clean_dates = Fix_Char_Dates(raw_date)
    } else {
      clean_num_date = Fix_Num_Dates(raw_date[numeric_loc])
      clean_char_date = Fix_Char_Dates(raw_date[-numeric_loc])
      clean_dates = sort(c(clean_num_date, clean_char_date))
    }
  return(clean_dates)
}
```

## Classifications

```{r}
# add metro and PHR code designations
# source: https://www.dshs.state.tx.us/chs/info/TxCoPhrMsa.xls
# add PHR readable names from https://dshs.texas.gov/regions/default.shtm
PHR_helper = data.frame(PHR = c("1", "2/3", "4/5N",
                                "6/5S", "7", "8",
                                "9/10", "11"),
                        PHR_Name = c('Lubbock PHR', 'Arlington PHR', 'Tyler PHR',
                                     'Houston PHR', 'Temple PHR', 'San Antonio PHR',
                                     'El Paso PHR', 'Harlingen PHR'))


county_classifications = read_xlsx('original-sources/helpers/county_classifications.xlsx', sheet = 1) %>% 
  slice(1:254) %>% 
  dplyr::select(1, 5, 8) %>%
  setNames(c('County', 'PHR', 'Metro_Area')) %>% 
  left_join(., PHR_helper, by = 'PHR') %>%
  mutate(PHR_Combined = paste0(PHR, ' - ', PHR_Name))
```

```{r}
# TSA levels
tsa_url = 'https://dshs.texas.gov/coronavirus/TexasCOVID-19HospitalizationsOverTimebyTSA.xlsx'
temp = tempfile()
download.file(tsa_url, temp, mode = 'wb')
DSHS_tsa_names = readxl::read_xlsx(temp)[3:24, 1:2]

names(DSHS_tsa_names) = c('TSA', 'TSA_Name')

# drop . suffix from TSA codes
DSHS_tsa_names$TSA = gsub('.', '', DSHS_tsa_names$TSA, fixed = TRUE)

# get list of counties per TSA
tsa = read.csv('original-sources/helpers/tsa_list.csv', header = F)[-1]
tsa_long = reshape::melt(tsa, id = c('V2', 'V3'))
tsa_long_complete = subset(tsa_long, value != '')[, c(1, 4)] %>% 
  setNames(c('TSA', 'County')) %>%
  mutate(County = trimws(County)) %>% 
  left_join(DSHS_tsa_names, by = 'TSA') %>% 
  distinct() %>% 
  mutate(TSA_Combined = paste0(TSA, ' - ', TSA_Name))


dshs_pops =
  read_csv('https://raw.githubusercontent.com/jeffbrennan/COVID-19/d03d476f7fb060dfd2e1a600a6a1e449df0ab8df/original-sources/DSHS_county_cases.csv') %>%
  select(County, Population) %>%
  distinct() %>%
  rename(Population_DSHS = Population)
```

## County level demographics

### race

```{r}
# 2019 county level race estimates
# collapse into asian, black, hispanic, white, other 
# exclude totals to avoid double counting
  race_group_df = data.frame(race = 
                             c('AA', 'AAC', 'BA', 'BAC', 'H', 'HAA',
                               'HAAC', 'HBA', 'HBAC', 'HIA', 'HIAC', 'HNA',
                               'HNAC', 'HTOM', 'HWA', 'HWAC', 'IA', 'IAC',
                               'NA', 'NAC', 'NH', 'NHAA', 'NHAAC', 'NHBA', 'NHBAC',
                               'NHIA', 'NHIAC', 'NHNA', 'NHNAC', 'NHTOM', 'NHWA',
                               'NHWAC', 'TOM', 'WA', 'WAC'),
                           race_group = 
                             c(NA, NA, NA, NA, 'Hispanic', NA,
                               NA, NA, NA, NA, NA , NA,
                               NA, NA, NA, NA, NA, 'Other',
                               NA, 'Other', NA, 'Asian', NA, 'Black', NA,
                               NA, NA, NA, NA, NA, 'White',
                               NA, 'Other', NA, NA))


Get_County_Race = function(age_groups) { 
  county_demo_race_prelim = read_csv('original-sources/helpers/demographics/county/county_pop_race.csv') %>% 
  filter(YEAR == '12' & AGEGRP %in% age_groups) %>% 
  select(-c(SUMLEV, STATE, COUNTY, STNAME, YEAR, AGEGRP, TOT_POP, TOT_MALE, TOT_FEMALE)) %>% 
  reshape2::melt(idvars = 'CTYNAME') %>% 
  separate(variable, c('race', 'gender')) %>% 
  group_by(CTYNAME, race) %>% 
  summarize(Total = sum(value, na.rm = TRUE)) %>% 
  left_join(race_group_df) %>% 
  group_by(CTYNAME, race_group) %>% 
  summarize(Total = sum(Total, na.rm = TRUE)) %>% 
  filter(!is.na(race_group)) %>% 
  ungroup() %>% 
  mutate(CTYNAME = gsub(' County', '', CTYNAME)) %>% 
  setNames(c('County', 'Race/Ethnicity', 'Population_Total'))

  county_demo_other_race  = read_csv('original-sources/helpers/demographics/county/county_pop_race.csv') %>% 
  filter(YEAR == '12' & AGEGRP %in% age_groups) %>% 
  select(-c(SUMLEV, STATE, COUNTY, STNAME, YEAR, AGEGRP, TOT_POP, TOT_MALE, TOT_FEMALE)) %>% 
  reshape2::melt(idvars = 'CTYNAME') %>% 
  separate(variable, c('race', 'gender')) %>% 
  filter(race %in% c('AA', 'AAC', 'BA', 'BAC', 'NA', 'NAC', 'IA', 'IAC', 'WA', 'WAC')) %>% 
  group_by(CTYNAME, race) %>% 
  summarize(Total = sum(value, na.rm = TRUE)) %>% 
  mutate(Total_combo = Total-lag(Total)) %>% 
  filter(str_detect(race, 'C')) %>% 
  mutate(`Race/Ethnicity` = 'Other') %>% 
  select(CTYNAME, `Race/Ethnicity`, Total_combo) %>% 
  setNames(c('County', 'Race/Ethnicity', 'Population_Total'))
  
  county_demo_race = rbind(county_demo_race_prelim, county_demo_other_race) %>%
    group_by(County, `Race/Ethnicity`) %>%
    summarize(Population_Total = sum(Population_Total)) %>%
    ungroup() %>%
    arrange(County, `Race/Ethnicity`)
  
  return(county_demo_race)
}

  
county_demo_race = Get_County_Race(c('0'))
county_demo_race_age_15 = Get_County_Race(as.character(seq(4, 18))) %>% rename('Population_16' = 'Population_Total')


503443 / county_demo_race %>%
  group_by(`Race/Ethnicity`) %>%
  summarize(sum(Population_Total)) %>%
  filter(`Race/Ethnicity` == 'Other') %>%
  select(2)

503443 / county_demo_race_age_15 %>%
  group_by(`Race/Ethnicity`) %>%
  summarize(sum(Population_16)) %>%
  filter(`Race/Ethnicity` == 'Other') %>%
  select(2)

# white
2499249 / 10034155

# county_demo_race_age_15 = read_csv('original-sources/helpers/demographics/county/county_pop_race.csv') %>% 
#   filter(YEAR == '12' & !AGEGRP %in% c('0', '1', '2', '3')) %>%
#   select(-c(SUMLEV, STATE, COUNTY, STNAME, YEAR, TOT_POP, TOT_MALE, TOT_FEMALE)) %>% 
#   reshape2::melt(id.vars = c('CTYNAME', 'AGEGRP')) %>% 
#   separate(variable, c('race', 'gender')) %>% 
#   group_by(CTYNAME, race) %>% 
#   summarize(Total = sum(value, na.rm = TRUE)) %>% 
#   left_join(race_group_df) %>% 
#   group_by(CTYNAME, race_group) %>% 
#   summarize(Population_16 = sum(Total, na.rm = TRUE)) %>% 
#   filter(!is.na(race_group)) %>% 
#   ungroup() %>% 
#   mutate(CTYNAME = gsub(' County', '', CTYNAME)) %>% 
#   setNames(c('County', 'Race/Ethnicity', 'Population_16'))
```


### age & sex

```{r}
# 2019 county level race estimates
# TODOl
age_lookup = data.frame(age =
                          c('POPEST', 'UNDER5', 'AGE513', 'AGE1417', 'AGE1824',
                            'AGE16PLUS', 'AGE18PLUS', 'AGE1544', 'AGE2544',
                            'AGE4564', 'AGE65PLUS', 'AGE04', 'AGE59', 'AGE1014',
                            'AGE1519', 'AGE2024', 'AGE2529', 'AGE3034', 'AGE3539',
                            'AGE4044', 'AGE4549', 'AGE5054', 'AGE5559', 'AGE6064',
                            'AGE6569', 'AGE7074', 'AGE7579', 'AGE8084', 'AGE85PLUS'),
                        age_group =
                          c('Total', NA, NA, NA, NA,
                            '16+', NA, NA, NA,
                            NA, NA, NA, NA, NA,
                            NA, NA, NA, NA, NA,
                            NA, NA, '50-64 years', '50-64 years', '50-64 years',
                            '65-79 years', '65-79 years', '65-79 years', '80+ years', '80+ years'))

demo_12_15 =  read_csv('original-sources/helpers/demographics/county/county_pop_age_sex.csv') %>%
  filter(YEAR == '12') %>% 
  select(-c(SUMLEV, STATE, COUNTY, STNAME, YEAR,
            POPESTIMATE,
            MEDIAN_AGE_TOT, MEDIAN_AGE_MALE, MEDIAN_AGE_FEM )) %>%
  reshape2::melt(idvars = 'CTYNAME') %>% 
  separate(variable, c('age', 'gender')) %>%
  filter(gender != 'TOT') %>% 
  filter(age %in% c('AGE1014', 'AGE1519')) %>% 
  mutate(value = ifelse(age == 'AGE1014', value * 0.6, value * 0.2)) %>% 
  group_by(CTYNAME, gender) %>% 
  summarize(Population_Total = round(sum(value), 0)) %>% 
  mutate(`Age Group` = '12-15 years') %>%
  rename(County = CTYNAME, Gender = gender)

demo_under_12 = read_csv('original-sources/helpers/demographics/county/county_pop_age_sex.csv') %>%
  filter(YEAR == '12') %>% 
  select(-c(SUMLEV, STATE, COUNTY, STNAME, YEAR,
            POPESTIMATE,
            MEDIAN_AGE_TOT, MEDIAN_AGE_MALE, MEDIAN_AGE_FEM )) %>%
  reshape2::melt(idvars = 'CTYNAME') %>% 
  separate(variable, c('age', 'gender')) %>%
  filter(gender != 'TOT') %>% 
  filter(age %in% c('UNDER5', 'AGE513')) %>% 
  mutate(value = ifelse(age == 'AGE513', value * (8/9), value)) %>% 
  group_by(CTYNAME, gender) %>% 
  summarize(Population_Total = round(sum(value), 0)) %>% 
  mutate(`Age Group` = '< 12 years') %>%
  rename(County = CTYNAME, Gender = gender)

county_demo_agesex = read_csv('original-sources/helpers/demographics/county/county_pop_age_sex.csv') %>%
  filter(YEAR == '12') %>% 
  select(-c(SUMLEV, STATE, COUNTY, STNAME, YEAR,
            POPESTIMATE,
            MEDIAN_AGE_TOT, MEDIAN_AGE_MALE, MEDIAN_AGE_FEM )) %>%
  reshape2::melt(idvars = 'CTYNAME') %>% 
  separate(variable, c('age', 'gender')) %>%
  filter(gender != 'TOT') %>% 
  left_join(age_lookup) %>% 
  group_by(CTYNAME, age_group, gender) %>% 
  summarize(Total = sum(value, na.rm = TRUE)) %>%
  filter(!is.na(age_group)) %>%
  spread(age_group, Total) %>%
  mutate('<16' = Total - `16+`) %>%
  mutate(`16-49 years` = `16+` - `50-64 years` - `65-79 years` - `80+ years`) %>% 
  select(-Total) %>% 
  reshape2::melt(idvars = c('CTYNAME', 'gender')) %>%
  setNames(c('County', 'Gender', 'Age Group', 'Population_Total')) %>% 
  rbind(demo_12_15) %>%
  rbind(demo_under_12) %>%
  mutate(County = gsub(' County', '', County)) %>% 
  mutate(Gender = recode(Gender, 'FEM' = 'Female', 'MALE' = 'Male'))
```


```{r}
# https://www.nrcs.usda.gov/wps/portal/nrcs/detail/tx/technical/dma/rwa/?cid=nrcs143_013697
# fips = read_csv('original-sources/helpers/fips_county.csv')

# 
# 
# # https://www.huduser.gov/portal/datasets/usps_crosswalk.html#codebook
# zip_crosswalk = read_csv('original-sources/helpers/zip_county.csv') %>%
#   inner_join(fips, by = c('COUNTY'= 'FIPS')) %>%
#   left_join(tsa_long_complete %>% dplyr::select(County, TSA_Combined), by = 'County') %>% 
#   left_join(county_classifications %>% dplyr::select(County, PHR_Combined)) %>%
#   left_join(dshs_pops) %>% 
#   group_by(ZIP) %>% 
#   mutate(dupe = n())
# 
# dupe_zips = zip_crosswalk %>% 
#   filter(dupe > 1) %>%
#   arrange(ZIP, -Population_DSHS) %>% 
#   slice(1)
# 
# zips_out = zip_crosswalk %>% 
#   filter(dupe == 1) %>% 
#   rbind(dupe_zips) %>% 
#   arrange(ZIP) %>% 
#   select(-dupe, -COUNTY, -Population_DSHS)

# https://www.zip-codes.com/state/tx.asp
# zip_crosswalk = read_csv('original-sources/helpers/zips_com_list.csv') %>%
#   mutate(County = gsub('Mcculloch', 'McCulloch', County)) %>% 
#   mutate(County = gsub('Mclennan', 'McLennan', County)) %>% 
#   mutate(County = gsub('De Witt', 'DeWitt', County)) %>% 
#   mutate(County = gsub('Mcmullen', 'McMullen', County)) %>%
#   # inner_join(fips, by = c('COUNTY'= 'FIPS')) %>%
#   left_join(tsa_long_complete %>% dplyr::select(County, TSA_Combined), by = 'County') %>%
#   left_join(county_classifications %>% dplyr::select(County, PHR_Combined)) %>%
#   left_join(dshs_pops) %>%
#   group_by(ZIP) %>%
#   mutate(dupe = n()) %>%
#   dplyr::select(-Population_DSHS, -dupe)
# 
# 
# # write_csv(dupe_zips, 'original-sources/helpers/dupe_zips.csv')
# write_csv(zip_crosswalk, 'original-sources/helpers/zip_crosswalk.csv')
```


# HOSPITAL LEVEL

```{r}
# TODO: finalize metrics of interest and add to tableau folder
# 
# hosp_dates = seq(as.Date('2020-12-07'), length = 52, by = 'week')
# hosp_date = max(hosp_dates[which(hosp_dates <= date_out)])
# hosp_date_f = format(hosp_date, '%Y%m%d')
# #
# 
# # https://healthdata.gov/sites/default/files/reported_hospital_capacity_admissions_facility_level_weekly_average_timeseries_20201214.csv
# base_hosp_url = 'https://healthdata.gov/sites/default/files/reported_hospital_capacity_admissions_facility_level_weekly_average_timeseries_'
# hosp_df = fread(paste0(base_hosp_url, hosp_date_f, '.csv'), na.strings = c('-999999', '-999999.0'))
# 
# fips_link = read.csv('original-sources/helpers/unpublished/county_fips.csv') %>%
#   dplyr::select(fips, county_name) %>%
#   setNames(c('fips_code', 'County'))
# 
# hosp_df_parsed = hosp_df %>%
#   filter(state == 'TX') %>%
#   dplyr::select(-ccn, -state, -hospital_subtype, -is_metro_micro,
#                 -total_patients_hospitalized_confirmed_influenza_and_covid_7_day_avg,
#                 -contains('_sum'), -contains('_coverage')) %>%
#   mutate(inpatient_beds_used_pct = inpatient_beds_used_7_day_avg / all_adult_hospital_inpatient_beds_7_day_avg) %>% 
#   mutate(total_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg
#            = total_adult_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg
#            + total_pediatric_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg) %>% 
#   mutate(total_patients_hospitalized_confirmed_covid_7_day_avg
#            = total_adult_patients_hospitalized_confirmed_covid_7_day_avg
#            + total_pediatric_patients_hospitalized_confirmed_covid_7_day_avg) %>% 
#   mutate(total_pediatric_icu_beds_7_day_avg
#            = icu_beds_used_7_day_avg
#            - total_staffed_adult_icu_beds_7_day_avg) %>% 
#   relocate(inpatient_beds_used_pct, .after = inpatient_beds_used_7_day_avg) %>%
#   relocate(total_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg,
#            .after = total_pediatric_patients_hospitalized_confirmed_and_suspected_covid_7_day_avg) %>% 
#   relocate(total_patients_hospitalized_confirmed_covid_7_day_avg, 
#            .after = total_pediatric_patients_hospitalized_confirmed_covid_7_day_avg) %>% 
#   relocate(total_pediatric_icu_beds_7_day_avg, .after = icu_beds_used_7_day_avg) %>%
#   setNames(gsub('_7_day_avg', '', names(.))) %>%
#   left_join(fips_link, by = 'fips_code') %>%
#   mutate(County = gsub(' County', '', County)) %>%
#   left_join(tsa_long_complete %>% dplyr::select(County, TSA_Combined), by = 'County') %>%
#   left_join(county_classifications %>% dplyr::select(County, PHR_Combined), by = 'County') %>%
#   relocate(County, .after = collection_week) %>%
#   relocate(TSA_Combined, .after = County) %>%
#   relocate(PHR_Combined, .after = TSA_Combined) %>%
#   relocate(fips_code, .after = PHR_Combined)
```

<!-- # hosp investigation -->

<!-- ```{r} -->
<!-- tmc_hospital_list = c('HARRIS HEALTH SYSTEM', 'HOUSTON METHODIST HOSPITAL', -->
<!--                   'UNIVERSITY OF TEXAS M D ANDERSON CANCER CENTER,THE', 'MEMORIAL HERMANN TEXAS MEDICAL CENTER', -->
<!--                   "ST LUKE'S PATIENTS MEDICAL CENTER", 'TEXAS CHILDRENS HOSP') -->

<!-- hhs_tmc = hosp_df_parsed %>%  -->
<!--   filter(hospital_name %in% tmc_hospital_list) -->


<!-- write.csv(hosp_df_parsed, -->
<!--           'C:/Users/jeffb/Desktop/Life/personal-projects/COVID/original-sources/helpers/unpublished/hhs_hospitals.csv', -->
<!--           row.names = FALSE) -->


<!-- write.csv(hhs_tmc, -->
<!--           'C:/Users/jeffb/Desktop/Life/personal-projects/COVID/original-sources/helpers/unpublished/hhs_tmc_comparison.csv', -->
<!--           row.names = FALSE) -->
<!-- ``` -->

# SCHOOL LEVEL

```{r}
# school files are small (~ 6kb - read every time and don't overwrite)
nyt_schools = rbindlist(lapply(list.files('original-sources/historical/nyt/archive', full.names = TRUE), read.csv)) %>% 
  setNames(c('School', 'City', 'County', 'Deaths_Cumulative', 'Cases_Cumulative', 'Date')) %>%
  mutate(Date = as.Date(Date)) %>% 
  mutate(Cases_Cumulative = ifelse(Cases_Cumulative == -1, NA, Cases_Cumulative))
```

## Texas school districts

```{r}
# data ending on Sunday posted on Friday (5 day lag)
school_dates = seq(as.Date('2020-10-11'), by = 'week', length.out = 52)
# no 11/22 update due to Thanksgiving
# missing 12/27 update prob due to christmas/new years
school_dates = school_dates[-12]
# school_dates = school_dates[-10]
school_date = max(school_dates[which(school_dates <= date_out - 5)])

tryCatch({
  # school_url = paste0('https://dshs.texas.gov/chs/data/tea/district-level-school-covid-19-case-data/campus-level-Data-',
  #                   format(school_date+2, '%m%d%Y'), '.xls')
  # school_url = 'https://dshs.texas.gov/chs/data/tea/district-level-school-covid-19-case-data/District-level-data.xlsx'
  school_url = 'https://dshs.texas.gov/chs/data/tea/district-level-school-covid-19-case-data/campus-level-Data_01122021v3.xls'
  temp = tempfile()
  download.file(school_url, temp, mode = 'wb')
  DSHS_schools_raw = data.frame(read_excel(temp, sheet = 1))
  },
  error = function(e) {
   school_url = paste0('https://dshs.texas.gov/chs/data/tea/district-level-school-covid-19-case-data/campus-level-Data_',
                    format(school_date+2, '%m%d%Y'), '.xls')
  temp = tempfile()
  download.file(school_url, temp, mode = 'wb')
  DSHS_schools_raw <<- data.frame(read_excel(temp, sheet = 1))
  })


first_row = which(DSHS_schools_raw[, 1] == 'District Name') + 1
last_row = which(DSHS_schools_raw[, 1] == 'ZEPHYR ISD')
names(DSHS_schools_raw)[1:2] = c('District', 'LEA')


# read in matching county data (overlapping counties available for public, but not private ISDs)
# public school source: http://tea-texas.maps.arcgis.com/sharing/rest/content/items/87c957f2ec334c83bc2b952bf6e64344/data
# private school source: http://mansfield.tea.state.tx.us/Tea.AskTed.Web/Forms/DownloadDefault.aspx
county_isd_wide = read.csv('original-sources/helpers/county_isd_wide.csv')

DSHS_schools_clean = DSHS_schools_raw[first_row:last_row, ] %>%
  mutate(LEA = as.numeric(gsub("'", '', LEA))) %>%
  mutate(District = str_to_title(District)) %>%
  mutate(District = gsub('Isd', 'ISD', District)) %>%
  mutate(District = gsub('\n', ' ', District)) %>%
  mutate(Date = school_date) %>%
  # dplyr::select(District, Date, County, LEA, everything()) %>%
  dplyr::select(District, Date, LEA, everything()) %>%
  mutate_at(5:ncol(.), as.numeric) %>%
  setNames(c('District', 'Date', 'LEA', 'Total_Enrollment', 'Approximate_Enrollment',
             'Cases_Weekly_GRADE_EE_3', 'Cases_Weekly_GRADE_4_6', 'Cases_Weekly_GRADE_7_12',
             'Cases_Weekly_Staff', 'Infections_Weekly_On_Campus',
             'Infections_Weekly_Off_Campus', 'Infections_Weekly_Unknown',

             'Cases_Cumulative_GRADE_EE_3', 'Cases_Cumulative_GRADE_4_6',
             'Cases_Cumulative_GRADE_7_12', 'Cases_Cumulative_Staff',
             'Infections_Cumulative_On_Campus', 'Infections_Cumulative_Off_Campus',
             'Infections_Cumulative_Unknown'))

# save for future combinations - avoids cleaning on every run
write.csv(DSHS_schools_clean,
          paste0('original-sources/historical/dshs-schools/DSHS_Schools_', school_date, '.csv'),
          row.names = FALSE)
```


```{r}
# combine previous cleaned versions w/ current week
DSHS_school_df = rbindlist(lapply(list.files('original-sources/historical/dshs-schools', full.names = TRUE), read.csv))

DSHS_school_df = DSHS_school_df %>% 
  mutate(District = gsub('\n', ' ', District, fixed = TRUE)) %>% 
  mutate(District = gsub('  ', ' ', District)) %>% 
  mutate(District = gsub('Lighthouse Charter School', 'Lighthouse Public Schools', District)) %>% 
  mutate(Total_Enrollment = as.numeric(Total_Enrollment)) %>% 
  mutate(Approximate_Enrollment = as.numeric(Approximate_Enrollment)) %>% 
  mutate(Total_Enrollment = ifelse(Total_Enrollment == 0, NA, Total_Enrollment)) %>% 
  mutate(Approximate_Enrollment = ifelse(Approximate_Enrollment == 0, NA, Approximate_Enrollment)) %>%
  distinct()

write_xlsx(list('school_data' = DSHS_school_df,
                'helper' = read.csv('original-sources/helpers/county_isd_long.csv')),
           'tableau/district_school_reopening.xlsx',
           format_headers = FALSE)
```

# COUNTY LEVEL

## Google mobility

```{r}
# fread for faster processing
mobility_data = fread('https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv')
```

```{r}
mobility_texas = mobility_data %>% 
  filter(sub_region_1 == 'Texas') %>% 
  dplyr::select(sub_region_2, date, 
                retail_and_recreation_percent_change_from_baseline,
                grocery_and_pharmacy_percent_change_from_baseline,
                parks_percent_change_from_baseline,
                transit_stations_percent_change_from_baseline,
                workplaces_percent_change_from_baseline,
                residential_percent_change_from_baseline) %>% 
  setNames(c('County', 'Date', 'Retail_Recreation', 'Grocery_Pharmacy',
             'Parks', 'Transit', 'Workplaces', 'Residential')) %>% 
  mutate(County =  sub('^$', 'Unallocated', County)) %>% 
  mutate(County = as.factor(gsub(' County', '', County))) %>% 
  filter(County != 'Unallocated') %>% 
  mutate(Date = as.Date(Date))

# # drop cols
# mobility_texas = mobility_texas[, -c(1:3, 5:7)]
# 
# # fix colnames
# names(mobility_texas) = c('County', 'Date', 'Retail_Recreation', 'Grocery_Pharmacy',
#                              'Parks', 'Transit', 'Workplaces', 'Residential')
# 
# # Add name for blank county cells & drop 'county' suffix
# mobility_texas$County = sub('^$', 'Unallocated', mobility_texas$County)
# mobility_texas$County = gsub(' County', '', mobility_texas$County)
# 
# # drop blank cells
# mobility_texas = subset(mobility_texas, County != 'Unallocated')
# 
# #fix types
# mobility_texas$County = as.factor(mobility_texas$County)
# mobility_texas$Date = as.Date(mobility_texas$Date)
```

## cases

```{r}
# download xlsx as tempfile and load using readxl
case_url = 'http://dshs.texas.gov/coronavirus/TexasCOVID19DailyCountyCaseCountData.xlsx'
temp = tempfile()
download.file(case_url, temp, mode = 'wb') 

DSHS_cases_wide = data.frame(read_excel(temp, sheet = 1, skip = 2)) %>% slice(1:254)
names(DSHS_cases_wide)[2:ncol(DSHS_cases_wide)] = Date_Parser(names(DSHS_cases_wide)[2:ncol(DSHS_cases_wide)])

DSHS_cases_long = DSHS_cases_wide %>% 
  reshape::melt('County.Name') %>% 
  setNames(c('County', 'Date', 'Cases_Cumulative')) %>%
  mutate(Date = as.Date(Date)) %>%
  mutate(Cases_Cumulative = as.integer(as.character(Cases_Cumulative))) %>% 
  group_by(County) %>%
  tidyr::complete(Date = seq.Date(min(Date), date_out, by="day")) %>%
  mutate(Cases_Cumulative_NA = Cases_Cumulative) %>% 
  tidyr::fill(Cases_Cumulative, .direction = "down")
```

## deaths

```{r}
death_url = 'https://dshs.texas.gov/coronavirus/TexasCOVID19DailyCountyFatalityCountData.xlsx'
temp = tempfile()
download.file(death_url, temp, mode = 'wb') 

DSHS_deaths_wide = data.frame(readxl::read_excel(temp, sheet = 1, skip = 2)) %>% slice(1:254)
names(DSHS_deaths_wide) = gsub('X', '', names(DSHS_deaths_wide))

names(DSHS_deaths_wide)[2:ncol(DSHS_deaths_wide)] = Date_Parser(names(DSHS_deaths_wide)[2:ncol(DSHS_deaths_wide)])

DSHS_deaths_long = DSHS_deaths_wide %>% 
  reshape2::melt('County.Name') %>% 
  setNames(c('County', 'Date', 'Deaths_Cumulative')) %>% 
  mutate(Date = as.Date(Date)) %>% 
  mutate(Deaths_Cumulative = as.integer(as.character(Deaths_Cumulative))) %>% 
  mutate(County = stringr::str_to_title(County)) %>% 
  mutate(County = gsub('De Witt', 'DeWitt', County)) %>%
  mutate(County = gsub('Dewitt', 'DeWitt', County)) %>%
  mutate(County = gsub('Mcculloch', 'McCulloch', County)) %>% 
  mutate(County = gsub('Mclennan', 'McLennan', County)) %>%
  mutate(County = gsub('Mcmullen', 'McMullen', County)) %>%
  group_by(County) %>%
  tidyr::complete(Date = seq.Date(min(Date), date_out, by="day")) %>%
  mutate(Deaths_Cumulative_NA = Deaths_Cumulative) %>%
  tidyr::fill(Deaths_Cumulative, .direction = "down") %>%
  mutate(Deaths_Daily = c(Deaths_Cumulative[1], diff(Deaths_Cumulative))) %>% 
  ungroup()
```

## testing

```{r}
# LEGACY
legacy_tests_long = read.csv('original-sources/historical/testing/DSHS_county_tests_legacy_cleaned.csv') %>% 
  mutate(Date = as.Date(Date))

# NEW
test_url = 'https://dshs.texas.gov/coronavirus/TexasCOVID-19CumulativeTestsbyCounty.xlsx'
temp = tempfile()
download.file(test_url, temp, mode = 'wb')

new_tests = data.frame(readxl::read_excel(temp, sheet = 1, skip = 1))
new_tests_long = new_tests %>% 
  filter(str_detect(County, 'County|Unknown|Total', negate = TRUE)) %>% 
  reshape::melt(id = 'County') %>% 
  setNames(c('County', 'Date', 'Tests_Cumulative')) %>% 
  mutate(Date = as.Date(as.integer(Date), '2020-09-12'))

# MERGE
merged_tests = rbind(legacy_tests_long, new_tests_long)

DSHS_tests_long = merged_tests %>%
  group_by(County) %>% 
  tidyr::complete(Date = seq.Date(min(Date), date_out, by="day")) %>%
  mutate(Tests_Cumulative_NA = Tests_Cumulative) %>%
  tidyr::fill(Tests_Cumulative, .direction = "down") %>%
  mutate(Tests_Daily = c(Tests_Cumulative[1], diff(Tests_Cumulative)))
```

## new cases

```{r}
# 10/23 - file includes all dates now
# get new cases as excel file
new_case_url ='https://dshs.texas.gov/coronavirus/TexasCOVID-19NewCasesOverTimebyCounty.xlsx'
temp = tempfile()
download.file(new_case_url, temp, mode = 'wb') 


# MANUALLY ADD MONTGOMERY CASES PER MISTI WILLINGHAM (11/20)
# 11/1 - 11/20 [manual entry] | 11/21 DSHS value
montgomery_new_cases = c(32, 61, 78, 110, 98, 124, 78, 77, 144, 97, 146, 133, 124, 103, 90, 109, 33, 3, 330, 162, 484)
montgomery_case_dates = seq(as.Date('2020-11-01'), as.Date('2020-11-21'), by = 'day')

DSHS_new_cases_wide = data.frame(readxl::read_excel(temp, sheet = 1, skip = 2)) %>% slice(1:254)
names(DSHS_new_cases_wide)[2:ncol(DSHS_new_cases_wide)] = Date_Parser(names(DSHS_new_cases_wide)[2:ncol(DSHS_new_cases_wide)])

DSHS_new_cases_long = DSHS_new_cases_wide %>%
  reshape2::melt('County') %>% 
  setNames(c('County', 'Date', 'Cases_Daily')) %>%
  mutate(Date = as.Date(Date)) %>%
  mutate(Cases_Daily = ifelse(Cases_Daily < 0, 0, Cases_Daily)) %>%
  mutate(Cases_Daily = replace(Cases_Daily, 
                               County == 'Montgomery' & Date %in% montgomery_case_dates,
                               montgomery_new_cases)) %>%
  arrange(Date, County)
```

## active cases

```{r}
old_active_cases_long = read.csv('original-sources/historical/active-cases/active_case_archive.csv') %>% 
  mutate(Date = as.Date(Date))


# current
new_case_url = 'https://dshs.texas.gov/coronavirus/TexasCOVID-19ActiveCaseDatabyCounty.xlsx'
temp = tempfile()
download.file(new_case_url, temp, mode = 'wb') 
new_active_cases = data.frame(readxl::read_excel(temp, sheet = 1, skip = 2)) %>%
  slice(which(County == 'Anderson'):which(County == 'Zavala')) %>% 
  dplyr::select(-Notes) %>% 
  select_if(function(x) all(!is.na(x)))

names(new_active_cases)[2:ncol(new_active_cases)] = Date_Parser(names(new_active_cases)[2:ncol(new_active_cases)])


# melt
new_active_cases_long = reshape::melt(new_active_cases, id = 'County') %>% 
  setNames(c('County', 'Date', 'Active_Cases_Cumulative')) %>%
  mutate(Date = as.Date(Date)) %>%
  group_by(Date) %>%
  # mutate(Date = as.Date(paste(str_extract_all(Date, '\\d+')[[1]], collapse = ' '), '%m%d')) %>% 
  ungroup() %>%
  group_by(County) %>% 
  distinct() %>%
  mutate(Active_Cases_Cumulative = as.integer(as.character(Active_Cases_Cumulative))) %>%
  tidyr::complete(Date = seq.Date(min(Date), date_out, by="day")) %>%
  mutate(Active_Cases_Cumulative_NA = Active_Cases_Cumulative) %>%
  tidyr::fill(Active_Cases_Cumulative, .direction = "down") %>%
  mutate(Active_Cases_Daily = c(Active_Cases_Cumulative[1], diff(Active_Cases_Cumulative))) %>%
  filter(!is.na(County))

DSHS_active_cases_long = rbind(old_active_cases_long, new_active_cases_long) %>% arrange(Date, County)
```


### merge

```{r}
# combine DSHS sources using merge helper function
# https://www.musgraveanalytics.com/blog/2018/2/12/how-to-merge-multiple-data-frames-using-base-r

county_counts = Reduce(function(x, y) merge(x, y, by = c('Date', 'County'), all=TRUE),
       list(DSHS_cases_long, DSHS_new_cases_long, DSHS_deaths_long, DSHS_tests_long,
            DSHS_active_cases_long))
```


## merge

```{r}
# DSHS pop - removed by DSHS 07/30 - defaulting to previous file
merged_dshs = Reduce(function(x, y) merge(x, y, by = 'County', all = TRUE),
                       list(county_counts, tsa_long_complete, dshs_pops, county_classifications))

# add TSA, PHR & HHSC combination
 merged_dshs$TSA_Combined = paste0(merged_dshs$TSA, ' - ', merged_dshs$TSA_Name)
merged_dshs$PHR_Combined = paste0(merged_dshs$PHR, ' - ', merged_dshs$PHR_Name)
# merged_dshs$HHSC_Combined = paste0(merged_dshs$HHSC, ' - ', merged_dshs$HHSC_Name)

merged_county = as.data.frame(merge(merged_dshs, mobility_texas,
                                    by = c('Date', 'County'), all = TRUE)) %>% 
  filter(!is.na(County) & County != 'Unknown')

# fix types
merged_county$County = as.factor(merged_county$County)
merged_county$Population_DSHS = as.numeric(merged_county$Population_DSHS)

# keep only relevant dates (previous dates include google mobility only)
merged_county = merged_county %>% 
  filter(Date >= as.Date('2020-03-04') & !is.na(County)) %>% 
  distinct() 
```

## TPR 

```{r}
Get_TPR = function() { 
  page = read_html('https://data.cms.gov/stories/s/q5r5-gjyu')
  tpr_url = page %>% html_nodes('a') %>% html_attr('href') %>%
    .[grepl('download', .)] %>% .[1] %>% gsub('%2F', '/', .)
  
  # temp dir needed for unzip to keep directory clean
  temp_dir = tempdir()
  temp_file = tempfile()
  download.file(tpr_url, temp_file, mode = 'wb')
  tpr_df = read_excel(unzip(temp_file, exdir = temp_dir)[[1]])
  tpr_date = Date_Parser(format(as.Date(str_match(tpr_df[2,2], '-(.*)')[2], '%B %d'), '%m-%d'))
  print(tpr_date)
  
  tpr_out = tpr_df %>% 
    setNames(.[which(tpr_df[, 1] == 'County'), ]) %>% 
    filter(State == 'TX') %>% 
    mutate(County = gsub(' County, TX', '', County)) %>% 
    dplyr::select(1, 7, 9) %>% 
    mutate_at(c(2,3), as.numeric) %>% 
    setNames(c('County', 'Tests', 'TPR_CMS')) %>% 
    mutate(Date = tpr_date) %>% 
    dplyr::select(County, Date, Tests, TPR_CMS)
  write.csv(tpr_out, paste0('original-sources/historical/cms_tpr/TPR_', tpr_date,  '.csv'),
            row.names = FALSE) 
  }
  
Get_TPR()
tpr_df = rbindlist(
         lapply(list.files('original-sources/historical/cms_tpr/', full.names = TRUE), read.csv),
         fill = TRUE) %>% 
         mutate(Date = as.Date(Date)) %>% 
  rename(TPR = TPR_CMS) %>%  
  mutate(TPR = ifelse(Date >= '2020-12-16', NA, TPR))
```


## TPR cpr

Source for TPR data post 12/16. Still use CMS tests and dates for case averages to keep % change section of stat analysis rmd the same

```{r}
# get latest url
page = read_html('https://beta.healthdata.gov/National/COVID-19-Community-Profile-Report/gqxm-d9w9')
file_loc = page %>%
  html_nodes('script') %>%
  str_detect('.xlsx') %>%
  which()

file_text = page %>% html_nodes('script') %>%
  .[file_loc] %>%
  html_text() %>%
  gsub('\n    var initialState =\n      ', '', .) %>%
  gsub('\n   ;\n  ', '', .)


newest_file = fromJSON(file_text)$view$attachments %>%
  filter(href %>% str_detect('.xlsx')) %>%
  dplyr::select(href) %>%
  slice(1) %>% 
  unlist()


file_date = as.Date(str_match(newest_file, '(Report |Report_)(.*)(_)')[3], '%Y%m%d')
file_url = (paste0('https://beta.healthdata.gov', newest_file))

temp = tempfile()
download.file(file_url, temp, mode = 'wb')

cpr_day = read_xlsx(temp, sheet = 6) %>%
  slice(1) %>% 
  dplyr::select(contains('VIRAL (RT-PCR) LAB TESTING: LAST WEEK')) %>% 
  names() %>% 
  # str_match(., '(\\d{1,2}).(?<=\\))') %>% 
  # str_match(., '-(\\d{1,2})') %>% 
  str_match(., '(\\d{1,2}),') %>%
  .[2] %>% 
  as.numeric()

if (cpr_day > as.numeric(format(Sys.Date(), '%d'))) { 
  cpr_month = format(seq.Date(Sys.Date(), length.out = 2, by = '-1 month')[2], '%m')
  cpr_date = as.Date(glue('{cpr_month}/{cpr_day}'), '%m/%d')  
} else { 
  cpr_date = as.Date(glue('{format(Sys.Date(), "%m")}/{cpr_day}'), '%m/%d')  
  }

cpr_tpr = read_xlsx(temp, sheet = 6, skip = 1) %>% 
  filter(`State Abbreviation` == 'TX') %>% 
  dplyr::select('County',
         contains('lab test positivity rate - last 7 days'),
         contains('diagnostic tests - last 7 days')) %>% 
  filter(County != 'Unallocated, TX') %>%
  mutate(County = gsub(' County, TX', '', County)) %>% 
  setNames(c('County', 'TPR_CPR', 'Tests')) %>% 
  mutate(Date = cpr_date) %>% 
  arrange(County)

# save
write.csv(cpr_tpr,
          paste0('original-sources/historical/cpr/cpr_tpr_', cpr_date, '.csv'),
          row.names = FALSE)


# add cms archive (8/19 - 12/09) (data represented 2 weeks of cases)
cpr_dates = list.files('original-sources/historical/cpr') %>% 
  gsub('cpr_tpr_', '', .) %>% 
  gsub('.csv', '', .) %>% 
  as.Date(.)

cms_dates = list.files('original-sources/historical/cms_tpr/') %>% 
  gsub('TPR_', '', .) %>% 
  gsub('.csv', '', .) %>% 
  as.Date(.)

TPR_dates = sort(unique(c(cpr_dates, cms_dates)))

# combine cpr archive
all_cpr_tpr = rbindlist(lapply(list.files('original-sources/historical/cpr/', full.names = TRUE), read.csv)) %>% 
  rename(TPR = TPR_CPR) %>% 
  mutate(Date = as.Date(Date)) %>%
  mutate(TPR = ifelse(is.na(TPR), 0, TPR)) %>%
  mutate(Tests = NA)

TPR_all_dates = data.frame(County = rep(county_classifications$County %>% unique(), length(TPR_dates)),
                                        Date = rep(TPR_dates, length(county_classifications$County %>% unique())))


cms_archive = tpr_df %>% filter(Date < '2020-12-16') %>% select(Date, County, Tests, TPR)
cms_new = tpr_df %>% filter(Date >= '2020-12-16') %>%
  rbind(TPR_all_dates %>%
        filter(Date >= '2020-12-16'),
      fill = TRUE) %>% 
  group_by(County) %>% 
  arrange(County, Date) %>%
  tidyr::fill(Tests, .direction = 'down') %>% 
  distinct() %>% 
  select(Date, County, Tests)

tpr_cases = merged_county %>% 
  dplyr::select(County, Date, Cases_Daily, Population_DSHS) %>%
  filter(Date >= as.Date(min(TPR_dates)) - 13 & Date <= max(TPR_dates)) %>%
  group_by(County) %>%
  mutate(Cases_100K_7Day_MA = (rollmean(Cases_Daily, k = 7, align = 'right',
                                        na.pad = TRUE, na.rm = TRUE)
                               / Population_DSHS) * 100000) %>%
  mutate(Cases_100K_14Day_MA = (rollmean(Cases_Daily, k = 14, align = 'right',
                                         na.rm = TRUE, na.pad = TRUE)
                                / Population_DSHS) * 100000) %>% 
  filter(Date %in% TPR_dates) %>% 
  dplyr::select(-Cases_Daily, -Population_DSHS, -Cases_100K_14Day_MA)


tpr_out = all_cpr_tpr %>%
  left_join(TPR_all_dates %>% filter(Date >= '2020-12-16')) %>%
  arrange(County, Date) %>%
  fill(Tests, .direction = 'down') %>% 
  fill(TPR, .direction = 'down') %>%
  rbind(cms_archive) %>%
  left_join(cms_new, by = c('County', 'Date')) %>%
  left_join(tpr_cases, by = c('County', 'Date')) %>%
  mutate(Tests.x = ifelse(is.na(Tests.y), Tests.x, Tests.y)) %>% 
  rename(Tests = Tests.x) %>%
  dplyr::select(-Tests.y) %>%
  dplyr::select(County, Date, TPR, Tests, Cases_100K_7Day_MA) %>%
  arrange(County, Date) %>% 
  distinct()

write.csv(tpr_out, 'tableau/county_TPR.csv', row.names = FALSE)
```

## vaccinations

```{r}
download.file('https://www.dshs.texas.gov/immunize/covid19/COVID-19-Vaccine-Data-by-County.xls', mode = 'wb', 
              glue('original-sources/historical/vaccinations/vaccinations_{date_out}.xlsx'))

# Clean_Vaccines = function(x) { 
#   file_date = Date_Parser(x)
#   df = read_excel(x, sheet = 2) %>%
#     mutate(Date = file_date) %>% 
#     setNames(c('County', 'PHR',
#                'Doses_Allocated', 'Doses_Administered',
#                'People_Vaccinated_Partial', 'People_Vaccinated_Full',
#                'Population_Over_16', 'Population_Over_65',
#                'Population_Phase_1A_Healthcare',
#                'Population_Phase1A_Care_Residents',
#                'Population_Phase_1B_Medical_Condition', 'Date')) %>% 
#     filter(!(County %in% c('Texas', '*Other', 'Federal Long-Term Care Vaccination Program'))) %>% 
#     dplyr::select(Date, everything())
# } 
# 
# vaccine_files = list.files('original-sources/historical/vaccinations/', full.names = TRUE)
# 
# county_vaccine = rbindlist(lapply(vaccine_files, Clean_Vaccines))
# demographics_vaccine = read_excel(vaccine_files[length(vaccine_files)], sheet = 3) %>% 
#   setNames(c('Gender', 'Age', 'Race_Ethnicity', 'Doses_Administered', 'People_Vaccinated_Partial', 'People_Vaccinated_Full'))
#   
# 
# write.csv(county_vaccine, 'tableau/county_vaccine.csv', row.names = FALSE)
# write.csv(demographics_vaccine, 'tableau/demographics_vaccine.csv', row.names = FALSE)
```

## vaccine providers

```{r}
download.file('https://genesis.soc.texas.gov/files/accessibility/vaccineprovideraccessibilitydata.csv', mode = 'wb', 
              glue('original-sources/historical/vaccine-providers/vaccination-providers_{date_out}.csv'))
```

## vaccines zip

```{r}
temp = tempfile()
download.file('https://dshs.texas.gov/coronavirus/TexasCOVID19VaccinesbyZIP.xlsx',
              temp, mode = 'wb') 
vaccines_zip = read_excel_allsheets(temp, col_option = FALSE)

vaccine_date = vaccines_zip[[1]] %>% slice(1) %>% select(2) %>% Date_Parser()

if (!is.na(vaccine_date)) {

vaccines_zip_out = vaccines_zip[[2]] %>% 
  setNames(c('ZIP', 'Doses_Administered', 'At_Least_One_Dose', 'Fully_Vaccinated')) %>% 
  mutate_all(as.numeric) %>% 
  filter(!is.na(ZIP)) %>% 
  mutate(Date = vaccine_date) %>% 
  select(Date, ZIP, everything())
write_csv(vaccines_zip_out, glue('original-sources/historical/vaccine-zip/vaccination-zip_{date_out}.csv'))
}


zip_archive = list.files(glue('original-sources/historical/vaccine-zip'), full.names = TRUE)

vaccines_zip_all = rbindlist(lapply(zip_archive, read_csv), fill = TRUE) %>% distinct() %>% 
  mutate(Date = as.Date(Date))

write_csv(vaccines_zip_all, 'tableau/zip_vaccine.csv')
```



## vaccine dashboard

```{r}
# TODO: update to only run when its monday and the files are new 
vax_dir = 'original-sources/historical/vax-dashboard'
date_modified = list.files(glue('{vax_dir}/temp/allocation'), full.names = TRUE)[1] %>%
  file.info() %>%
  .[['ctime']] %>%
  as.Date(.)

if (format(date_out, '%A') == 'Monday' & (date_out - date_modified == -1)) {
  vax_allocation = rbindlist(lapply(list.files(glue('{vax_dir}/temp/allocation/'), full.names = TRUE),
                                read.csv, fileEncoding="UTF-16LE", sep = '\t'),
                         fill = TRUE) %>%
    filter(X != 'DosesAllocatedWindow along Week No' & 
           X != 'SumDosesAllocated (copy)') %>%
    dplyr::select(-X) %>%
    reshape2::melt(id = c('Allocation.Week.Range', 'CountyNameDisplay', 'Dose.Number..group.')) %>%
    dplyr::select(-variable) %>%
    setNames(c('Date', 'County', 'Dose', 'Count')) %>%
    mutate(Count = ifelse(Count == '', NA, Count)) %>%
    mutate(Count = as.numeric(gsub(',', '', Count))) %>%
    na.omit() %>%
    mutate(County = gsub(' County', '', County)) %>%
    filter(County != 'Texas') %>%
    mutate(Date = as.Date(Date, '%m/%d/%Y')) %>%
    reshape(idvar = c('Date', 'County'), timevar = 'Dose', direction = 'wide') %>%
    rename('Doses_Allocated_1' = `Count.First Doses`,
           'Doses_Allocated_2' = `Count.Second Doses`) %>%
    group_by(Date, County) %>%
    mutate(Doses_Allocated_1 = sum(Doses_Allocated_1, `Count.Federal Programs, First Doses`, na.rm = TRUE)) %>% 
    dplyr::select(Date, County, Doses_Allocated_1, Doses_Allocated_2)

  vax_admin = rbindlist(lapply(list.files(glue('{vax_dir}/temp/admin/'), full.names = TRUE),
                                read.csv, fileEncoding="UTF-16LE", sep = '\t'),
                         fill = TRUE) %>%
    reshape2::melt(id = c('Week.Start.End', 'CountyNameDisplay')) %>%
    dplyr::select(-variable) %>%
    setNames(c('Date', 'County', 'Doses_Administered')) %>%
    mutate(Doses_Administered) %>%
    mutate(Doses_Administered = as.numeric(gsub(',', '', Doses_Administered))) %>%
    na.omit() %>%
    mutate(County = gsub(' County', '', County)) %>%
    mutate(Date = str_extract(Date, '\\- (.*)')) %>%
    mutate(Date = gsub('- ', '', Date)) %>%
    mutate(Date = as.Date(Date, '%m/%d/%Y'))

## FULL
  demo_archive = list.files(glue('{vax_dir}/archive/'), full.names = TRUE)
  
  age_archive = rbindlist(lapply(demo_archive %>% .[str_detect(., 'age')], read_csv), fill = TRUE) %>% distinct()
  race_archive = rbindlist(lapply(demo_archive %>% .[str_detect(., 'race')], read_csv), fill = TRUE) %>% distinct()
  
  vax_age_full = rbindlist(lapply(list.files(glue('{vax_dir}/temp/demo_age_full/'), full.names = TRUE),
                                  read.csv, fileEncoding="UTF-16LE", sep = '\t'),
                           fill = TRUE) %>%
    dplyr::select(X, X.1, X.3, People.Vaccinated) %>%
    reshape2::melt(id = c('X', 'X.1', 'X.3')) %>%
    dplyr::select(-variable) %>%
    setNames(c('Age', 'County', 'Gender', 'Fully_Vaccinated')) %>%
    mutate(Date = max(vax_admin$Date)) %>%
    mutate(County = gsub(' County', '', County)) %>%
    dplyr::select(Date, County, everything()) %>% 
    mutate(Date = as.Date(Date)) %>%
    mutate(Fully_Vaccinated = as.numeric(gsub(',', '', Fully_Vaccinated))) %>%
    arrange(Date, County)


  Read_Race = function(x) {
    county_name = str_match(x, '\\/race_(.*)\\.csv')[2]
    x_out = read.csv(x, fileEncoding="UTF-16LE", sep = '\t') %>%
              mutate(County = county_name)
    return(x_out)
    }


  vax_race_full = rbindlist(lapply(list.files(glue('{vax_dir}/temp/demo_race_full/'), full.names = TRUE),
                               Read_Race),
                         fill = TRUE) %>%
    setNames(c('Race', 'dump1', 'Fully_Vaccinated', 'dump2', 'County')) %>%
    mutate(Date = max(vax_admin$Date)) %>%
    dplyr::select(Date, County, Race, Fully_Vaccinated, -dump1, -dump2) %>% 
    mutate(Date = as.Date(Date)) %>%
    mutate(Fully_Vaccinated = as.numeric(gsub(',', '', Fully_Vaccinated))) %>%
    arrange(Date, County)

  
# PARTIAL
  vax_age_partial = rbindlist(lapply(list.files(glue('{vax_dir}/temp/demo_age_partial/'), full.names = TRUE),
                                  read.csv, fileEncoding="UTF-16LE", sep = '\t'),
                           fill = TRUE) %>%
    dplyr::select(X, X.1, X.3, People.Vaccinated) %>%
    reshape2::melt(id = c('X', 'X.1', 'X.3')) %>%
    dplyr::select(-variable) %>%
    setNames(c('Age', 'County', 'Gender', 'At_Least_One_Vaccinated')) %>%
    mutate(Date = max(vax_admin$Date)) %>%
    mutate(County = gsub(' County', '', County)) %>%
    dplyr::select(Date, County, everything()) %>% 
    mutate(Date = as.Date(Date)) %>%
    mutate(At_Least_One_Vaccinated = as.numeric(gsub(',', '', At_Least_One_Vaccinated))) %>%
    arrange(Date, County)


  vax_race_partial = rbindlist(lapply(list.files(glue('{vax_dir}/temp/demo_race_partial/'), full.names = TRUE),
                               Read_Race),
                         fill = TRUE) %>%
    setNames(c('Race', 'dump1', 'At_Least_One_Vaccinated', 'dump2', 'County')) %>%
    mutate(Date = max(vax_admin$Date)) %>%
    dplyr::select(Date, County, Race, At_Least_One_Vaccinated, -dump1, -dump2) %>% 
    mutate(Date = as.Date(Date)) %>%
    mutate(At_Least_One_Vaccinated = as.numeric(gsub(',', '', At_Least_One_Vaccinated))) %>%
    arrange(Date, County)
 
  vax_age = vax_age_full %>% 
    left_join(vax_age_partial, by = c('County', 'Date', 'Age', 'Gender')) %>% 
    plyr::rbind.fill(age_archive) %>% 
    arrange(County, Date)
  
  vax_race = vax_race_full %>% 
    left_join(vax_race_partial, by = c('County', 'Date', 'Race')) %>% 
    plyr::rbind.fill(race_archive) %>% 
    arrange(County, Date)

  pop_files = list.files('original-sources/historical/vaccinations/', full.names = TRUE)

  vax_pop_counts = read_xlsx(pop_files[length(pop_files)], sheet = 2) %>%
    dplyr::select(1, 7, 8, 9, 10, 11) %>%
      setNames(c('County',
                 'Population_Over_16', 'Population_Over_65',
                 'Population_Phase_1A_Healthcare',
                 'Population_Phase1A_Care_Residents',
                 'Population_Phase_1B_Medical_Condition', 'Date')) %>%
      filter(!(County %in% c('Texas', '*Other', 'Federal Long-Term Care Vaccination Program')))
  
  vax_out = vax_allocation %>% 
    full_join(vax_admin, by = c('Date', 'County')) %>% 
    left_join(vax_pop_counts, by = 'County') %>% 
    full_join(vax_age_partial %>% 
                group_by(Date, County) %>%
                summarize(At_Least_One_Vaccinated = sum(At_Least_One_Vaccinated, na.rm = TRUE))) %>% 
    full_join(vax_age_full %>% 
                group_by(Date, County) %>%
                summarize(Fully_Vaccinated = sum(Fully_Vaccinated, na.rm = TRUE))) %>% 
    dplyr::select(Date, County, Doses_Allocated_1, Doses_Allocated_2,
                  Doses_Administered, At_Least_One_Vaccinated, Fully_Vaccinated,
                  everything())

  
  write.csv(vax_out, 'tableau/county_vaccine.csv', row.names = FALSE)
  write.csv(vax_age, 'tableau/demographics_vax_age.csv', row.names = FALSE)
  write.csv(vax_age %>% filter(Date == max(Date)),
            glue('{vax_dir}/archive/{max(vax_admin$Date)}_demographics_vax_age.csv'), row.names = FALSE)
  write.csv(vax_race, 'tableau/demographics_vax_race.csv', row.names = FALSE)
  write.csv(vax_race %>% filter(Date == max(Date)),
            glue('{vax_dir}/archive/{max(vax_admin$Date)}_demographics_vax_race.csv'), row.names = FALSE)
}
```


## vax dashboard new

```{r}
dashboard_archive = list.files('C:/Users/jeffb/Desktop/Life/personal-projects/COVID/original-sources/historical/vaccinations', full.names = TRUE)

# combine all sheets, obtain unique date, count combos, save
all_dashboard_files = lapply(dashboard_archive, read_excel_allsheets, add_date = TRUE, col_option = FALSE, skip_option = 0)

county_vaccinations = 
  rbindlist(
  lapply(
    lapply(all_dashboard_files, `[[`, 'By County'),
           function(x) return(x %>%
                                setNames(slice(., 1)) %>%
                                slice(2:nrow(.)) %>%
                                rename('Date' = ncol(.)))
    )
    , fill = TRUE) %>% 
  filter(!(`County Name` %in% c('Texas',
                                'Federal Long-Term Care Vaccination Program',
                                'Federal Pharmacy Retail Vaccination Program'))) %>%
  # distinct_at(vars(-c(`County Name`, Date)), .keep_all = TRUE) %>%
  select(Date, `County Name`, `Total Doses Allocated`,
         `Vaccine Doses Administered`, `People Fully Vaccinated`,
         `Population, 16+`, `Population, 65+`) %>%
  setNames(c('Date', 'County', 'Doses_Allocated',
             'Doses_Administered', 'Fully_Vaccinated',
             'Population_16', 'Population_65')) %>%
  mutate_at(vars(-County, -Date), as.numeric) %>%
  mutate(Doses_Allocated_Per_16 = Doses_Allocated / Population_16,
         Doses_Allocated_Per_65 = Doses_Allocated / Population_65,
         Doses_Administered_Per_16 = Doses_Administered / Population_16,
         Doses_Administered_Per_65 = Doses_Administered / Population_65,
         Fully_Vaccinated_Per_16 = Fully_Vaccinated / Population_16,
         Fully_Vaccinated_Per_65 = Fully_Vaccinated / Population_65)


# DSHS swapped counts of full and partial vaccinations on 3/12 [duplicated on 3/13].
vaccinations_312 = 
  read_xlsx("original-sources/historical/vaccinations/vaccinations_2021-03-12.xlsx", sheet = 2) %>% 
  slice(2:nrow(.)) %>%
  mutate(Date = as.Date('2021-03-12')) %>%
  filter(!(`County Name` %in% c('Texas',
                              'Federal Long-Term Care Vaccination Program',
                              'Federal Pharmacy Retail Vaccination Program'))) %>%
  select(- `People Fully Vaccinated`) %>% 
  rename(`People Fully Vaccinated` = `People Vaccinated with at least One Dose`) %>%
  # distinct_at(vars(-c(`County Name`, Date)), .keep_all = TRUE) %>% 
  select(Date, `County Name`, `Total Doses Allocated`,
         `Vaccine Doses Administered`, `People Fully Vaccinated`,
         `Population, 16+`, `Population, 65+`) %>%
  setNames(c('Date', 'County', 'Doses_Allocated',
             'Doses_Administered', 'Fully_Vaccinated',
             'Population_16', 'Population_65')) %>%
  mutate_at(vars(-County, -Date), as.numeric) %>%
  mutate(Doses_Allocated_Per_16 = Doses_Allocated / Population_16,
         Doses_Allocated_Per_65 = Doses_Allocated / Population_65,
         Doses_Administered_Per_16 = Doses_Administered / Population_16,
         Doses_Administered_Per_65 = Doses_Administered / Population_65,
         Fully_Vaccinated_Per_16 = Fully_Vaccinated / Population_16,
         Fully_Vaccinated_Per_65 = Fully_Vaccinated / Population_65)


vaccinations_312 = vaccinations_312 %>% rbind(vaccinations_312 %>% mutate(Date = as.Date('2021-03-13')))

# Average between 4/6 and 4/8 for missing 4/7 file
vaccinations_407 = county_vaccinations %>%
  filter(Date == '2021-04-06' | Date == '2021-04-08') %>% 
  group_by(County) %>% 
  summarize(across(Doses_Allocated:Fully_Vaccinated_Per_65, ~round(mean(.x, na.rm = TRUE), 0))) %>% 
  mutate(Date = as.Date('2021-04-07'))

county_vaccinations_out = county_vaccinations %>% 
  filter(Date != '2021-03-12' & Date != '2021-03-13') %>% 
  rbind(vaccinations_312) %>%
  rbind(vaccinations_407) %>%
  arrange(Date, County) %>%
  mutate(County = gsub('\\*Other|\\* Other', 'Other', County)) %>%
  left_join(tsa_long_complete %>% select(County, TSA_Combined)) %>% 
  left_join(county_classifications %>% select(County, PHR_Combined, Metro_Area)) %>% 
  select(-contains('_Per')) %>% 
  left_join(county_demo_agesex %>%
              select(County, `Age Group`, Population_Total) %>%
              filter(`Age Group` %in% c('<16', '16+')) %>%
              group_by(County) %>%
              summarize(Population_Total = sum(Population_Total)) %>%
              arrange(-Population_Total)) %>%
  relocate(Population_Total, .before = TSA_Combined)



county_vaccinations_out %>%
  filter(County == 'Harris') %>% 
  filter(Date > as.Date('2021-04-05') & Date <= as.Date('2021-04-10')) %>%
  ggplot(aes(x = Date, y = Fully_Vaccinated)) + 
  geom_point() + 
  theme_pubr()


county_vaccinations_out %>%
  filter(County == 'Harris') %>%
  arrange(County, Date) %>%
  group_by(County) %>%
  mutate(date_check = ifelse(Date - lag(Date) > 1, TRUE, FALSE)) %>% 
  filter(date_check == TRUE)


county_vaccinations_out %>% 
  filter(County == 'Harris') %>% 
  filter(Date >= as.Date('2021-04-01')) %>% 
  View()

write_csv(county_vaccinations_out, 'tableau/sandbox/county_daily_vaccine.csv')
```

#### state
```{r}
state_demo = lapply(all_dashboard_files, `[[`, 'By Age, Gender, Race') %>%
  discard(is.null) %>%
  .[[length(.)]] %>% 
  setNames(slice(., 1)) %>%
  slice(2:nrow(.)) %>%
  select(1:(ncol(.)-1)) %>%
  filter(`Age Group` != 'Total') %>%
  setNames(c('Gender', 'Age_Group', 'Race/Ethnicity',
             'Doses_Administered', 'At_Least_One_Vaccinated', 'Fully_Vaccinated')) %>%
  left_join(county_demo_race %>%
              group_by(`Race/Ethnicity`) %>%
              summarize(State_Race_Total = sum(Population_Total, na.rm = TRUE))) %>% 
  left_join(county_demo_agesex %>%
              filter(`Age Group` == '<16' | `Age Group` == '16+') %>%
              group_by(Gender) %>% 
              summarize(State_Gender_Total = sum(Population_Total, na.rm = TRUE))) %>% 
 left_join(county_demo_agesex %>%
              group_by(`Age Group`) %>%
              summarize(State_Age_Total = sum(Population_Total, na.rm = TRUE)) %>%
              rename('Age_Group' = `Age Group`)) %>%
  mutate_at(vars(-Gender, -Age_Group, -`Race/Ethnicity`), as.numeric) %>% 
  mutate(Doses_Administered_Per_Race = Doses_Administered / State_Race_Total,
         Doses_Administered_Per_Gender = Doses_Administered / State_Gender_Total,
         Doses_Administered_Per_Age = Doses_Administered / State_Age_Total,
         At_Least_One_Vaccinated_Per_Race = At_Least_One_Vaccinated / State_Race_Total,
         At_Least_One_Vaccinated_Per_Gender = At_Least_One_Vaccinated / State_Gender_Total,
         At_Least_One_Vaccinated_Per_Age = At_Least_One_Vaccinated / State_Age_Total,
         Fully_Vaccinated_Per_Race = Fully_Vaccinated / State_Race_Total,
         Fully_Vaccinated_Per_Gender = Fully_Vaccinated / State_Gender_Total,
         Fully_Vaccinated_Per_Age = Fully_Vaccinated / State_Age_Total)

write_csv(state_demo, 'tableau/sandbox/state_vaccine_demographics.csv')
```

```{r}
measure_cols = c('Doses_Administered', 'At_Least_One_Vaccinated', 'Fully_Vaccinated')


state_demo_stacked = 
  state_demo %>%
    select(c(contains('Gender'), measure_cols, -contains('Per'))) %>%
    mutate(Group_Type = 'Gender') %>%
    rename(Group = Gender,
           Population_Total = State_Gender_Total) %>%
    group_by(Group_Type, Group, Population_Total) %>% 
    summarize_at(measure_cols, sum, na.rm = TRUE) %>%
  rbind(state_demo %>%
    select(c(contains('Race'), measure_cols, -contains('Per'))) %>%
    mutate(Group_Type = 'Race') %>% 
    rename(Group = `Race/Ethnicity`,
           Population_Total = State_Race_Total)) %>%
    group_by(Group_Type, Group, Population_Total) %>% 
    summarize_at(measure_cols, sum, na.rm = TRUE) %>%
  rbind(state_demo %>%
    select(c(contains('Age'), measure_cols, -contains('Per'))) %>%
    mutate(Group_Type = 'Age') %>%
    rename(Group = Age_Group,
           Population_Total = State_Age_Total)) %>%
    group_by(Group_Type, Group, Population_Total) %>% 
    summarize_at(measure_cols, sum, na.rm = TRUE) %>%
  relocate(Group_Type, .before = Group)


under_12 = data.frame(Group_Type = 'Age',
                      Group = '< 12 years',
                      Doses_Administered = 0,
                      At_Least_One_Vaccinated = 0,
                      Fully_Vaccinated = 0) %>% 
  left_join(county_demo_agesex %>% filter(`Age Group` == '< 12 years') %>%
              group_by(`Age Group`) %>%
              summarize(Population_Total = sum(Population_Total)) %>% 
              rename(Age_Group = `Age Group`) %>%
              select(Age_Group, Population_Total),
            by = c('Group' = 'Age_Group'))



state_demo_stacked_out = 
  state_demo_stacked %>% 
  rbind(under_12) %>% 
  arrange(Group, Group_Type) %>%
  mutate(Population_Total =
           ifelse(Group == '65-79 years & 80+ years',
                    county_demo_agesex %>%
                    filter(`Age Group` %in% c('65-79 years', '80+ years')) %>%
                    summarize(Population_Total = sum(Population_Total)) %>% 
                    select(Population_Total) %>% 
                    unlist(),
                  Population_Total)) %>% 
  left_join(county_demo_race_age_15 %>%
              group_by(`Race/Ethnicity`) %>%
              summarize(Population_16 = sum(Population_16)),
            by = c('Group' = 'Race/Ethnicity')) %>%
  mutate(Population_16 = ifelse(Group_Type == 'Age', Population_Total, Population_16)) %>% 
  mutate(Population_16 = ifelse(Group == '< 16 years', 0, Population_16)) %>% 
  left_join(county_demo_agesex %>%
              filter(`Age Group` == '16+') %>%
              group_by(Gender) %>%
              summarize(Population_16 = sum(Population_Total)),
            by = c('Group' = 'Gender')) %>% 
  mutate(Population_16 = ifelse(!is.na(Population_16.y), Population_16.y, Population_16.x)) %>% 
  select(-contains('.x'), -contains('.y')) %>% 
  relocate(Population_16, .after = Population_Total)


write_csv(state_demo_stacked_out, 'tableau/sandbox/stacked_state_vaccine_demographics.csv')
```

```{r}
county_vax_race = lapply(all_dashboard_files, `[[`, 'By County, Race') %>%
  discard(is.null) %>%
  .[[length(.)]] %>% 
  setNames(slice(., 1)) %>%
  slice(2:nrow(.)) %>%
  select(1:(ncol(.)-1)) %>% 
  setNames(c('County', 'Race/Ethnicity',
             'Doses_Administered', 'At_Least_One_Vaccinated', 'Fully_Vaccinated')) %>% 
  left_join(county_demo_race) %>% 
  mutate_at(vars(-County, -`Race/Ethnicity`), as.numeric) %>%
  mutate(Doses_Administered_Per_Race = Doses_Administered / Population_Total) %>% 
  mutate(At_Least_One_Vaccinated_Per_Race = At_Least_One_Vaccinated / Population_Total) %>% 
  mutate(Fully_Vaccinated_Per_Race = Fully_Vaccinated / Population_Total) %>% 
  filter(!(County %in% c('Other', 'Grand Total'))) %>% 
  select(-contains('_Per'))


write_csv(county_vax_race, 'tableau/sandbox/county_vax_race.csv')
```

```{r}
county_vax_age = lapply(all_dashboard_files, `[[`, 'By County, Age') %>%
  discard(is.null) %>%
  .[[length(.)]] %>% 
  setNames(slice(., 1)) %>%
  slice(2:nrow(.)) %>%
  select(1:(ncol(.)-1)) %>% 
  setNames(c('County', 'Age_Group',
             'Doses_Administered', 'At_Least_One_Vaccinated', 'Fully_Vaccinated')) %>% 
  left_join(county_demo_agesex %>%
              group_by(County, `Age Group`) %>% 
              summarize(Population_Total = sum(Population_Total, na.rm = TRUE)) %>%
              rename('Age_Group' = `Age Group`)) %>%  
  mutate_at(vars(-County, -`Age_Group`), as.numeric) %>%
  mutate(Doses_Administered_Per_Age = Doses_Administered / Population_Total) %>% 
  mutate(At_Least_One_Vaccinated_Per_Age = At_Least_One_Vaccinated / Population_Total) %>% 
  mutate(Fully_Vaccinated_Per_Age = Fully_Vaccinated / Population_Total) %>% 
  filter(!(County %in% c('Other', 'Grand Total'))) %>% 
  select(-contains('_Per'))


write_csv(county_vax_age, 'tableau/sandbox/county_vax_age.csv')
```


# TSA LEVEL

## Computed

```{r}
# longitudinal counts (sum)
DSHS_tsa_counts =
    merged_county %>%
    group_by(Date, TSA, TSA_Name) %>% 
    summarize_at(vars(Cases_Cumulative, Cases_Daily,
                      Deaths_Cumulative, Deaths_Daily,
                      Tests_Cumulative, Tests_Daily,
                      Active_Cases_Cumulative, Active_Cases_Daily),
                 funs(sum))

# static pop counts (sum)
DSHS_tsa_pops = 
  subset(merged_county, Date == '2020-03-04') %>%
  group_by(TSA) %>%
  summarize_at(vars(Population_DSHS),
               funs(sum))

# longitudinal google data (mean)
DSHS_tsa_google = 
  merged_county %>%
  group_by(Date, TSA, TSA_Name) %>%
  summarize_at(vars(Retail_Recreation, Grocery_Pharmacy,
                    Parks, Transit,
                    Workplaces, Residential),
               funs(weighted.mean(., Population_DSHS)), na.rm = TRUE)

DSHS_tsa = merge(DSHS_tsa_counts, DSHS_tsa_google, by = c('Date', 'TSA', 'TSA_Name'))
DSHS_tsa = merge(DSHS_tsa, DSHS_tsa_pops, by = 'TSA', all = TRUE)
```

## DSHS hospitals

```{r}
hosp_url = 'https://dshs.texas.gov/coronavirus/CombinedHospitalDataoverTimebyTSA.xlsx'
temp = tempfile()

download.file(hosp_url, temp, mode = 'wb') 
DSHS_tsa_hosp = read_excel_allsheets(temp)
 
DSHS_hosp_clean = function(df, var_name) { 
  names(df) = df[1, ]
  df = df[2:23, c(1, 3:ncol(df))]
  df$`TSA ID` = gsub('.', '', df$`TSA ID`, fixed = TRUE)

  # add temp fix for DSHS duplicated dates (8/8) (fixed by DSHS 8/10)
  # TODO: add dynamic handling
  if (length(grep('.x', names(df)) > 0)) { 
    df = df[, -grep('.x', names(df))]
    names(df) = gsub('.y', '', names(df))
  }

  # TODO: make date conversion function
  dates = names(df)[2:length(names(df))]
  numeric_dates = which(is.na(as.Date(dates, format = '%Y-%m-%d')))
  
  # convert from 5 digit excel numeric format
  # https://stackoverflow.com/questions/43230470/how-to-convert-excel-date-format-to-proper-date-in-r
  dates[numeric_dates] = format(as.Date(as.integer(dates[numeric_dates]), origin = '1899-12-30'))
  dates[-numeric_dates] = format(as.Date(dates[-numeric_dates]), '%Y-%m-%d')
  names(df)[2:length(names(df))] = dates

  df_long = reshape::melt(df, id = 'TSA ID')
  names(df_long) = c('TSA', 'Date', var_name)
  df_long$Date = as.Date(df_long$Date)
  
  if(length(which(df_long$Date == '2008-08-08')) > 0) {
    df_long$Date[which(df_long$Date == '2008-08-08')] = as.Date('2020-08-08')
  }
  
  return(df_long)
}
# 1,2,3 references the 3 sheets produced by DSHS
hosp_1 = DSHS_hosp_clean(DSHS_tsa_hosp[[1]], 'Hospitalizations_Total')
hosp_2 = DSHS_hosp_clean(DSHS_tsa_hosp[[8]], 'Hospitalizations_General')
hosp_3 = DSHS_hosp_clean(DSHS_tsa_hosp[[9]], 'Hospitalizations_ICU')
hosp_cap1 = DSHS_hosp_clean(DSHS_tsa_hosp[[4]], 'Beds_Available_Total')
hosp_cap2 = DSHS_hosp_clean(DSHS_tsa_hosp[[5]], 'Beds_Available_ICU')
hosp_cap3 = DSHS_hosp_clean(DSHS_tsa_hosp[[10]], 'Beds_Occupied_Total')
hosp_cap4 = DSHS_hosp_clean(DSHS_tsa_hosp[[11]], 'Beds_Occupied_ICU')
```

## DSHS dashboard

```{r}
# pull DSHS dashboard data using link found from inspect element -> network
DSHS_json_hosp_tsa = jsonlite::fromJSON("https://services5.arcgis.com/ACaLB9ifngzawspq/arcgis/rest/services/DSHS_COVID_Hospital_Data/FeatureServer/0/query?f=json&where=1%3D1&returnGeometry=false&spatialRel=esriSpatialRelIntersects&outFields=*&outSR=102100&resultOffset=0&resultRecordCount=25&resultType=standard&cacheHint=true")[['features']][['attributes']]

rac_xwalk = DSHS_json_hosp_tsa %>% select(TSA, RAC) %>% rename(TSA_Fixed = TSA)

DSHS_json_hosp_tsa = DSHS_json_hosp_tsa %>% 
  select(TSA, TotalStaff, AvailHospi, AvailICUBe, AvailVenti, COVIDPatie) %>% 
  rename(Hospital_Beds_Staffed = TotalStaff,
         ICU_Beds_Available = AvailICUBe,
         Ventilators_Available = AvailVenti,
         Current_Cases = COVIDPatie,
         Hospital_Beds_Available = AvailHospi)

# export today's file
write_csv(DSHS_json_hosp_tsa, glue('original-sources/historical/hosp/tsa_hosp_{date_out}.csv'))

# read in all files
hosp_list = list.files('original-sources/historical/hosp', pattern = '*.csv', full.names = TRUE)
hosp_dates = sapply(hosp_list, function(x) str_extract(x, '\\d{4}-\\d{2}-\\d{2}'))
tsa_all_hosp = lapply(hosp_list, read.csv, fileEncoding = 'UTF-8-BOM')
names(tsa_all_hosp) = hosp_dates

tsa_combined_hosp_orig = rbindlist(tsa_all_hosp, fill = TRUE, idcol = TRUE) %>% 
  dplyr::select(-Date) %>% 
  rename(Date = .id) %>%
  # dplyr::select(TSA, Date, Ventilators_Available) %>%
  left_join(rac_xwalk, by = c('TSA' = 'RAC')) %>%
  mutate(TSA_Fixed = ifelse(is.na(TSA_Fixed), TSA, TSA_Fixed)) %>%
  select(-TSA) %>% 
  rename(TSA = TSA_Fixed) %>% 
  relocate(TSA, .before = Date) %>% 
  mutate(Date = as.Date(Date, '%Y-%m-%d')) %>% 
  distinct() %>% 
  group_by(TSA, Date) %>% 
  mutate(delete_flag = ifelse(TSA == 'L' & row_number() == 2 | TSA == 'M' & row_number() == 1 & n() == 2, 1, 0)) %>% 
  filter(delete_flag != 1) %>% 
  select(-delete_flag) %>% 
  ungroup()


wrong_dates_icu = tsa_combined_hosp_orig %>%
  filter(TSA == 'D' & Date <= '2021-05-06') %>%
  arrange(Ventilators_Available) %>%
  mutate(n = row_number()) %>%
  filter (n < 66) %>%
  select(Date) %>%
  filter(Date != '2021-02-04' & Date != '2021-01-05') %>% 
  unlist() %>% 
  as.Date()

wrong_dates_cases = c('2021-02-04', '2021-01-05') %>% as.Date()

wrong_dates_icu_df = tsa_combined_hosp_orig %>%
          filter(Date %in% wrong_dates_icu) %>%
          select(-Ventilators_Available) %>%
          rename(Ventilators_Available = ICU_Beds_Available) %>%
          select(TSA, Date, Ventilators_Available)

wrong_dates_cases_df = tsa_combined_hosp_orig %>%
          filter(Date %in% wrong_dates_cases) %>%
          select(-Ventilators_Available) %>%
          rename(Ventilators_Available = Current_Cases) %>%
          select(TSA, Date, Ventilators_Available)


tsa_combined_hosp = 
  tsa_combined_hosp_orig %>%
  select(TSA, Date, Ventilators_Available) %>% 
  filter(!Date %in% wrong_dates_icu & !Date %in% wrong_dates_cases) %>%
  rbind(wrong_dates_icu_df) %>% 
  rbind(wrong_dates_cases_df) %>%
  filter(Date != '2020-07-23')
```

## merge

```{r}
merged_tsa = Reduce(function(x, y) merge(x, y, by = c('Date', 'TSA'), all = TRUE),
                    list(DSHS_tsa, tsa_combined_hosp,
                         hosp_1, hosp_2, hosp_3,
                         hosp_cap1, hosp_cap2, hosp_cap3, hosp_cap4))



# fix types & ensure TSA values are valid
merged_tsa = merged_tsa %>% 
  mutate_at(vars(Beds_Available_Total, Beds_Available_ICU, Ventilators_Available,
                 Beds_Occupied_Total, Beds_Occupied_ICU, Hospitalizations_Total,
                 Hospitalizations_General, Hospitalizations_ICU),
            funs(as.character)) %>%
  mutate_at(vars(Beds_Available_Total, Beds_Available_ICU, Ventilators_Available,
                 Beds_Occupied_Total, Beds_Occupied_ICU, Hospitalizations_Total,
                 Hospitalizations_General, Hospitalizations_ICU),
            funs(as.integer)) %>%
  mutate(TSA_Combined = paste0(TSA, ' - ', TSA_Name)) %>%
  filter(!is.na(TSA) & !is.na(Date)) %>% 
  distinct()
```


# STATE LEVEL

```{r}
state_url = 'https://www.dshs.state.tx.us/coronavirus/TexasCOVID19CaseCountData.xlsx'
temp = tempfile()
download.file(state_url, temp, mode = 'wb')
dshs_header = names(read_excel(temp, sheet = 1)[1])

current_year =  substr(Sys.Date(), 1, 4)
dshs_date = str_extract(dshs_header, '\\d{4}\\/\\d{2}\\/\\d{2}')
# dshs_date = paste0(current_year, '/',  str_extract_all(dshs_header, '\\d*\\/\\d*')[[1]])
dshs_date = format(as.Date(dshs_date), '%Y_%m_%d')

# save state level file to historical database for longitudinal demo
download.file(state_url, paste0('original-sources/historical/state/dshs_',
                                dshs_date, '.xlsx'), mode = 'wb')
```

## DSHS Demographics

## POST 12/11 DEMOGRAPHIC SCRAPING 

```{r}

Clean_Demographics = function(index) {

  group_conversion =  c('Age', 'Gender', 'Race')
  
  case_df = weekly_demo[[index]] %>%
    select(1:2) %>%
    setNames(c('Group', 'Cases_Cumulative')) %>%
    filter(!Group %in% c('Pending DOB', 'Total', 'Unknown', 'Grand Total')) %>%
    mutate(Date = date_out) %>%
    mutate(Group_Type = group_conversion[index]) %>%
    group_by(Date) %>%
    mutate(Cases_PCT = Cases_Cumulative / sum(Cases_Cumulative)) %>%
    dplyr::select(Date, Group_Type, Group, Cases_Cumulative, Cases_PCT)

  death_df = weekly_demo[[index + 3]] %>% 
    select(1:2) %>%
    setNames(c('Group', 'Deaths_Cumulative')) %>%
    filter(!Group %in% c('Pending DOB', 'Total', 'Unknown', 'Grand Total')) %>%
    mutate(Date = date_out) %>%
    mutate(Group_Type = group_conversion[index]) %>%
    group_by(Date) %>%
    mutate(Deaths_PCT = Deaths_Cumulative / sum(Deaths_Cumulative)) %>%
    dplyr::select(Date, Group_Type, Group, Deaths_Cumulative, Deaths_PCT)

  clean_df = merge(case_df, death_df, by = c('Date', 'Group_Type', 'Group'))
}

# TODO: add contingency if not posted on friday
demo_releases = seq(as.Date('2020-09-25'), by = 'week', length = 52)

if (date_out %in% demo_releases) {
  demo_url = 'https://dshs.texas.gov/coronavirus/TexasCOVID19Demographics.xlsx'
  temp = tempfile()
  download.file(demo_url, temp, mode = 'wb')
  weekly_demo = read_excel_allsheets(temp, col_option = FALSE)
  download.file(demo_url, glue('original-sources/historical/demo-archive/demo_{date_out}.xlsx'))
  
  
  daily_demo_stack = rbindlist(lapply(seq(1,3), Clean_Demographics))
  write.csv(daily_demo_stack, paste0('original-sources/historical/demo/dshs_', date_out, '.csv'), row.names = FALSE)
}
```


### merge

```{r}
daily_demo_stack_all = rbindlist(lapply(list.files('original-sources/historical/demo/',
                                                   full.names = TRUE), read.csv)) %>% 
  mutate(Date = as.Date(Date))
  # distinct(Cases_Cumulative, Cases_PCT, Deaths_Cumulative, Deaths_PCT, .keep_all = TRUE)

legacy_demo = read.csv('original-sources/helpers/legacy_demographics.csv') %>% mutate(Date = as.Date(Date))

demo_stacked_combined = rbind(legacy_demo, daily_demo_stack_all) %>% 
  group_by(Group_Type, Group) %>% 
  mutate(Cases_Daily = as.numeric(c(Cases_Cumulative[1], diff(Cases_Cumulative)))) %>%
  mutate(Cases_Daily_NO_NEGATIVE = ifelse(Cases_Daily < 0, 0, Cases_Daily)) %>%
  mutate(Deaths_Daily = as.numeric(c(Deaths_Cumulative[1], diff(Deaths_Cumulative)))) %>%
  mutate(Deaths_Daily_NO_NEGATIVE = ifelse(Deaths_Daily < 0, 0, Deaths_Daily)) %>% 
  dplyr::select(Date, Group_Type, Group, Cases_Cumulative, Cases_PCT, Cases_Daily, Cases_Daily_NO_NEGATIVE, everything()) %>% 
  arrange(Date)
```


# OUTPUT

## Schools

```{r}
write.csv(nyt_schools, file = 'original-sources/historical/nyt/nyt_colleges.csv', row.names = F)
```

## County

```{r}
merged_county_out = merged_county %>% 
  dplyr::select(-c(Cases_Cumulative_NA, Deaths_Cumulative_NA,
                   Tests_Cumulative_NA, Active_Cases_Cumulative_NA))


merged_county_out %>% 
  group_by(County) %>% 
  summarize(n()) %>% 
  View()


merged_county_out %>%
  select(Date, TSA, Cases_Daily, Tests_Daily, Population_DSHS) %>%
  group_by(Date, TSA) %>% 
  summarize_if(is.numeric, sum, na.rm = TRUE) %>% 
  group_by(Date, TSA) %>%
  summarize(n()) %>%
  View()

write.csv(merged_county_out, 'tableau/county.csv', row.names = FALSE)
```

## TSA

```{r}
# TODO: fix names
hosp_tsa = merged_tsa %>% 
  dplyr::select(Date, TSA, TSA_Name, TSA_Combined, Population_DSHS, Ventilators_Available,
                Hospitalizations_Total, Hospitalizations_General, Hospitalizations_ICU,
                Beds_Available_Total, Beds_Available_ICU, Beds_Occupied_Total, Beds_Occupied_ICU) %>% 
  filter(Date >= min(hosp_cap1$Date))


hosp_tsa %>% select(Date, TSA) %>% group_by(Date, TSA) %>% summarize(n()) %>% View()
# diagnostics
hosp_tsa %>% select(TSA) %>% distinct()
hosp_tsa %>% select(Date, TSA, Ventilators_Available) %>% filter(TSA == 'D') %>%
  ggplot(aes(x = Date, y = Ventilators_Available)) + 
  geom_point() + 
  theme_pubr()

write.csv(hosp_tsa, file = 'tableau/hospitalizations_tsa.csv', row.names = F)
```

## Demographics

```{r}
write.csv(demo_stacked_combined, file = 'tableau/stacked_demographics.csv', row.names = FALSE)
```



<!-- <!-- ## vax viz --> -->

<!-- ### cases -->

<!-- ```{r} -->
<!-- vaccination_quartile = county_vaccinations %>% -->
<!--   filter(Date == max(Date)) %>% -->
<!--   mutate(Vaccination_Rate = Fully_Vaccinated / Population_16) %>% -->
<!--   select(County, Vaccination_Rate) %>% -->
<!--   na.omit() %>% -->
<!--   mutate(Vaccination_Quartile = ntile(Vaccination_Rate, 4)) %>% -->
<!--   select(County, Vaccination_Quartile) -->
<!-- # select(-Vaccination_Rate) -->



<!-- vax_cases = DSHS_new_cases_long %>% -->
<!--   left_join(county_vaccinations %>% -->
<!--               # select(-Population_16) %>% -->
<!--               mutate(Vaccination_Rate = Fully_Vaccinated / Population_16) %>% -->
<!--               left_join(vaccination_quartile, by = c('County')) %>% -->
<!--               select(Date, County, Vaccination_Rate, -->
<!--                      Vaccination_Quartile, Population_16) %>% -->
<!--               na.omit()) %>% -->
<!--   group_by(County) %>% -->
<!--   fill(Vaccination_Quartile, .direction = 'updown') %>% -->
<!--   fill(Population_16, .direction = 'updown') %>% -->
<!--   left_join(dshs_pops) %>% -->
<!--   mutate(Cases_14Day_MA = rollmean(Cases_Daily, k = 14, align = 'right', na.rm = TRUE, na.pad = TRUE)) %>% -->
<!--   mutate(Cases_100K_16_14Day_MA = (rollmean(Cases_Daily, k = 14, align = 'right', -->
<!--                                          na.rm = TRUE, na.pad = TRUE) -->
<!--                                 / Population_16) * 100000) %>% -->
<!--   mutate(Cases_100K_14Day_MA = (rollmean(Cases_Daily, k = 14, align = 'right', -->
<!--                                          na.rm = TRUE, na.pad = TRUE) -->
<!--                                 / Population_DSHS) * 100000) %>% -->
<!--   filter(Date >= as.Date('2021-01-01')) %>% -->
<!--   ungroup() %>% -->
<!--   mutate(Vaccination_Quartile = as.factor(Vaccination_Quartile)) %>% -->
<!--   left_join(tsa_long_complete %>% select(County, TSA)) %>% -->
<!--   arrange(Date, County) %>% -->
<!--   group_by(County) %>% -->
<!--   mutate(Cases_14Day_MA_PCT = (Cases_14Day_MA / (Cases_14Day_MA)[1] - 1) * 100) %>% -->
<!--   ungroup() -->


<!-- corr_results = list() -->
<!-- # correlation coefficient -->
<!-- for (date in vax_cases %>% -->
<!--     select(Date, Vaccination_Rate, County, Cases_100K_16_14Day_MA) %>% -->
<!--     na.omit() %>% -->
<!--     select(Date) %>% -->
<!--     mutate(Date = format(Date, '%Y-%m-%d')) %>% -->
<!--     unlist() %>% -->
<!--     unique()) {  -->




<!--   corr_test = cor.test(mydata$Vaccination_Rate, mydata$Cases_100K_16_14Day_MA) -->
<!--   corr_results = append(corr_results, list(list('date' = date, -->
<!--                                            'estimate' = corr_test[['estimate']], -->
<!--                                            'p' =  corr_test[['p.value']]))) -->
<!-- } -->

<!-- Calc_Corr = function(date) {  -->

<!--   mydata = vax_cases %>% filter(Date == as.Date(date)) -->

<!--   corr_test = cor.test(mydata$Vaccination_Rate, mydata$Cases_100K_16_14Day_MA) -->
<!--   corr_results = list('date' = date, -->
<!--                       'correlation' = unname(corr_test[['estimate']]), -->
<!--                       'p' =  corr_test[['p.value']]) -->

<!--   return(corr_results) -->
<!-- } -->


<!-- vax_dates = vax_cases %>%  -->
<!--   select(Date, County, Vaccination_Rate, Cases_100K_16_14Day_MA) %>%  -->
<!--   na.omit() %>%  -->
<!--   select(Date) %>%  -->
<!--   mutate(Date = format(Date, '%Y-%m-%d')) %>%  -->
<!--   unlist() %>% -->
<!--   unique() -->

<!-- case_vax_corr_df =  rbindlist(lapply(vax_dates, Calc_Corr)) %>%  -->
<!--   mutate(p = ifelse(p < 0.05, '< 0.05', '>= 0.05')) -->


<!-- ggplot(case_vax_corr_df, aes(x = as.Date(date), y = correlation, color = p)) +  -->
<!--   geom_line(color = 'black') + -->
<!--   geom_point(size = 3) + -->
<!--   geom_hline(yintercept = 0, linetype = 'dashed', color = 'grey20') +  -->
<!--   labs(title = 'Correlation between Vaccination Rate & Cases Per Capita*',  -->
<!--        subtitle = '*cases adjusted per 100K Over 16 years old', -->
<!--        x = 'Date', -->
<!--        y = "Pearson's Correlation Coefficient") +  -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   theme_pubr() -->
<!-- ``` -->


<!-- ```{r} -->
<!-- # individua -->
<!-- # l counties colored by group -->
<!-- # ggplot(vax_cases %>% filter(!is.na(Vaccination_Quartile)), -->
<!-- #        aes(x = Date, y = Cases_100K_16_14Day_MA, color = Vaccination_Quartile, group = County)) + -->
<!-- #   geom_line(alpha = 0.5, size = 0.5) + -->
<!-- #   scale_color_brewer(palette = 'Greens') + -->
<!-- #   theme_pubr() -->

<!-- # vax_cases %>% group_by(Date, Vaccination_Quartile) %>% -->
<!-- #   summarize(Cases = median(Cases_100K_16_14Day_MA, na.rm = TRUE)) %>% -->
<!-- #   na.omit() %>% -->
<!-- #   ggplot(aes(x = Date, y = Cases, color = Vaccination_Quartile, fill = Vaccination_Quartile)) + -->
<!-- #   geom_smooth(alpha = 0.5) + -->
<!-- #   # geom_point(size = 1.5, alpha = 0.8) + -->
<!-- #   scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!-- #   scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!-- #   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!-- #   theme_pubr() -->

<!-- vax_cases %>% group_by(Date, Vaccination_Quartile) %>% -->
<!--   summarize(Cases = median(Cases_100K_16_14Day_MA, na.rm = TRUE)) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Cases, color = Vaccination_Quartile, fill = Vaccination_Quartile)) + -->
<!--   geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'Cases Per 100K > 16 (14 Day MA)', -->
<!--        title = 'COVID Cases by Vaccination Quartile', -->
<!--        subtitle = 'daily cases adjusted per 100k population > 16 years old') + -->
<!--   scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   theme_pubr() -->


<!-- vax_cases %>% group_by(Date, Vaccination_Quartile) %>% -->
<!--   summarize(Cases = median(Cases_100K_14Day_MA, na.rm = TRUE)) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Cases, color = Vaccination_Quartile, fill = Vaccination_Quartile)) + -->
<!--   geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'Cases Per 100K (14 Day MA)', -->
<!--        title = 'COVID Cases by Vaccination Quartile') + -->
<!--   scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   theme_pubr() -->

<!-- vax_cases %>% group_by(Date, Vaccination_Quartile) %>% -->
<!--   summarize(Cases = median(Cases_100K_16_14Day_MA, na.rm = TRUE)) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Cases, color = Vaccination_Quartile, fill = Vaccination_Quartile)) + -->
<!--   geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'Cases Per 100K > 16 (14 Day MA)', -->
<!--        title = 'COVID Cases by Vaccination Quartile', -->
<!--        subtitle = 'daily cases adjusted per 100k population > 16 years old') + -->
<!--   scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   theme_pubr() -->

<!-- # percent diff -->
<!-- vax_cases %>% group_by(Date, Vaccination_Quartile) %>% -->
<!--   summarize(Cases = median(Cases_14Day_MA_PCT, na.rm = TRUE)) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Cases, color = Vaccination_Quartile, fill = Vaccination_Quartile)) + -->
<!--   geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'Cases (14 Day MA) Percent Difference', -->
<!--        title = 'COVID Cases by Vaccination Quartile') + -->
<!--   scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   theme_pubr() -->

<!-- ``` -->

<!-- ### cases - tsa -->

<!-- ```{r} -->
<!-- vax_cases %>% group_by(Date, Vaccination_Quartile) %>% -->
<!--   mutate(Cases = median(Cases_100K_16_14Day_MA, na.rm = TRUE)) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Cases, color = Vaccination_Quartile, fill = Vaccination_Quartile)) + -->
<!--   geom_smooth(alpha = 0.5, size = 2) + -->
<!--   labs(y = 'Cases Per 100K (14 Day MA) Percent Difference', -->
<!--        title = 'COVID Cases by Vaccination Quartile', -->
<!--        subtitle = 'daily cases adjusted per 100k population > 16 years old') + -->
<!--   scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   facet_wrap(~TSA, scales = 'free') + -->
<!--   theme_pubr() -->


<!-- vax_cases %>% group_by(Date, Vaccination_Quartile) %>% -->
<!--   mutate(Cases = median(Cases_100K_14Day_MA, na.rm = TRUE)) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Cases, color = Vaccination_Quartile, fill = Vaccination_Quartile)) + -->
<!--   geom_smooth(alpha = 0.5, size = 2) + -->
<!--   labs(y = 'Cases (14 Day MA)', -->
<!--        title = 'COVID Cases by Vaccination Quartile') + -->
<!--   scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   facet_wrap(~TSA, scales = 'free') + -->
<!--   theme_pubr() -->
<!-- ``` -->

<!-- ### hospitalizations -->

<!-- ```{r} -->
<!-- vaccination_tsa_quartile = county_vaccinations %>% -->
<!--   left_join(tsa_long_complete %>% select(County, TSA)) %>% -->
<!--   group_by(Date, TSA) %>% -->
<!--   mutate(Fully_Vaccinated = sum(Fully_Vaccinated, na.rm = TRUE), -->
<!--          Population_16 = sum(Population_16, na.rm = TRUE)) %>% -->
<!--   mutate(Vaccination_Rate = Fully_Vaccinated / Population_16) %>% -->
<!--   # select(Date, TSA, Vaccination_Rate) %>% -->
<!--   select(Date, TSA, Vaccination_Rate, Population_16) %>% -->
<!--   na.omit() %>% -->
<!--   distinct() %>% -->
<!--   group_by(Date) %>% -->
<!--   mutate(Vaccination_Quartile = ntile(Vaccination_Rate, 4)) %>% -->
<!--   mutate(Vaccination_Quartile_raw = Vaccination_Quartile) -->
<!-- # select(-Vaccination_Rate) -->

<!-- vax_hospitalizations = hosp_1 %>% -->
<!--   left_join(county_vaccinations %>% -->
<!--               select(-Population_16) %>% -->
<!--               left_join(tsa_long_complete %>% select(County, TSA)) %>% -->
<!--               left_join(vaccination_tsa_quartile, by = c('TSA', 'Date')) %>% -->
<!--               select(Date, TSA, Vaccination_Rate, -->
<!--                      Vaccination_Quartile, Vaccination_Quartile_raw, Population_16) %>% -->
<!--               na.omit() %>% -->
<!--               distinct()) %>% -->
<!--   mutate(Hospitalizations_Total = as.numeric(Hospitalizations_Total)) %>% -->
<!--   group_by(TSA) %>% -->
<!--   fill(Vaccination_Quartile, .direction = 'updown') %>% -->
<!--   fill(Population_16, .direction = 'updown') %>% -->
<!--   group_by(TSA) %>% -->
<!--   mutate(Hosp_14Day_MA = (rollmean(Hospitalizations_Total, k = 14, align = 'right', -->
<!--                                            na.rm = TRUE, na.pad = TRUE))) %>% -->
<!--   mutate(Hosp_100K_16_14Day_MA = (rollmean(Hospitalizations_Total, k = 14, align = 'right', -->
<!--                                          na.rm = TRUE, na.pad = TRUE) -->
<!--                                 / Population_16) * 100000) %>% -->
<!--   mutate(Hosp_100K_14Day_MA = (rollmean(Hospitalizations_Total, k = 14, align = 'right', -->
<!--                                          na.rm = TRUE, na.pad = TRUE))) %>% -->
<!--   filter(Date >= '2021-01-01') %>% -->
<!--   ungroup() %>% -->
<!--   mutate(Vaccination_Quartile = as.factor(Vaccination_Quartile)) %>% -->
<!--   arrange(Date, TSA) %>% -->
<!--   group_by(TSA) %>% -->
<!--   mutate(Hosp_14Day_MA_PCT = ((Hosp_14Day_MA / (Hosp_14Day_MA)[1] - 1)) * 100) %>% -->
<!--   ungroup() -->





<!-- vax_hospitalizations %>% group_by(Date, Vaccination_Quartile) %>% -->
<!--   mutate(Hosp = mean(Hosp_100K_16_14Day_MA, na.rm = TRUE)) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Hosp, color = Vaccination_Quartile, fill = Vaccination_Quartile)) + -->
<!--   geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'COVID Hospitalizations Per 100K (14 Day MA)', -->
<!--        title = 'COVID Hosp by Vaccination Quartile', -->
<!--        subtitle = 'daily covid hospitalizations adjusted per 100k population > 16 years old') + -->
<!--   scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '1 month', date_labels = '%b', expand = c(0,0)) + -->
<!--   theme_pubr() -->


<!-- vax_hospitalizations %>% group_by(Date, Vaccination_Quartile) %>% -->
<!--   mutate(Hosp = mean(Hosp_100K_14Day_MA, na.rm = TRUE)) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Hosp, color = Vaccination_Quartile, fill = Vaccination_Quartile)) + -->
<!--   geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'Hosp (14 Day MA)', -->
<!--        title = 'COVID Hospitalization by Vaccination Quartile') + -->
<!--   scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   theme_pubr() -->
<!-- ``` -->

<!-- ### tsa -->
<!-- ```{r} -->
<!-- vax_hospitalizations %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Hosp_100K_14Day_MA, color = Vaccination_Quartile, fill = Vaccination_Quartile)) + -->
<!--   geom_line() + -->
<!--   labs(y = 'Hosp (14 Day MA)', -->
<!--        title = 'COVID Hospitalization by Vaccination Quartile') + -->
<!--   scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   facet_wrap(~TSA, scales = 'free') + -->
<!--   theme_pubr() -->
<!-- ``` -->

<!-- ### Top 5 and Bottom 5 Outliers -->

<!-- ```{r} -->

<!-- # counties -->
<!-- top_5_counties = county_vaccinations %>% -->
<!--   mutate(Vaccination_Rate = Fully_Vaccinated / Population_16) %>% -->
<!--   select(Date, County, Vaccination_Rate) %>% -->
<!--   na.omit() %>% -->
<!--   filter(Date == max(Date) & County != 'Kenedy') %>% -->
<!--   arrange(-Vaccination_Rate) %>% -->
<!--   slice(1:5) %>% -->
<!--   select(County) %>% -->
<!--   unlist() -->

<!-- bottom_5_counties = county_vaccinations %>% -->
<!--   mutate(Vaccination_Rate = Fully_Vaccinated / Population_16) %>% -->
<!--   select(Date, County, Vaccination_Rate) %>% -->
<!--   na.omit() %>% -->
<!--   filter(Date == max(Date)) %>% -->
<!--   arrange(Vaccination_Rate) %>% -->
<!--   slice(1:5) %>% -->
<!--   select(County) %>% -->
<!--   unlist() -->

<!-- # tsa -->
<!-- top_5_tsa = vax_hospitalizations %>% -->
<!--   select(Date, TSA, Vaccination_Rate) %>% -->
<!--   na.omit() %>% -->
<!--   filter(Date == max(Date)) %>% -->
<!--   arrange(-Vaccination_Rate) %>% -->
<!--   slice(1:5) %>% -->
<!--   select(TSA) %>% -->
<!--   unlist() -->

<!-- bottom_5_tsa = vax_hospitalizations %>% -->
<!--   select(Date, TSA, Vaccination_Rate) %>% -->
<!--   na.omit() %>% -->
<!--   filter(Date == max(Date)) %>% -->
<!--   arrange(Vaccination_Rate) %>% -->
<!--   slice(1:5) %>% -->
<!--   select(TSA) %>% -->
<!--   unlist() -->

<!-- ``` -->

<!-- #### cases -->

<!-- ```{r} -->
<!-- p1 = vax_cases %>% -->
<!--   filter(County %in% c(top_5_counties)) %>% -->
<!--   # mutate(Vax_Category = ifelse(County %in% top_5_counties, 'Top_5', 'Bottom_5')) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Cases_100K_16_14Day_MA, color = County, fill = County)) + -->
<!--   geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'Cases Per 100K (14 Day MA)', -->
<!--        title = 'COVID Cases by Vaccination Rate Outliers (Top 5)', -->
<!--        subtitle = 'daily cases adjusted per 100k population > 16 years old') + -->
<!--   # scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   # facet_wrap(~Vax_Category, scales = 'free', ncol = 1) + -->
<!--   theme_pubr() -->

<!-- p2 = vax_cases %>% -->
<!--   filter(County %in% c(bottom_5_counties)) %>% -->
<!--   # mutate(Vax_Category = ifelse(County %in% top_5_counties, 'Top_5', 'Bottom_5')) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Cases_100K_16_14Day_MA, color = County, fill = County)) + -->
<!--   geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'Cases Per 100K (14 Day MA)', -->
<!--        title = 'COVID Cases by Vaccination Rate Outliers (Bottom 5)', -->
<!--        subtitle = 'daily cases adjusted per 100k population > 16 years old') + -->
<!--   # scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   # facet_wrap(~Vax_Category, scales = 'free', ncol = 1) + -->
<!--   theme_pubr() -->

<!-- gridExtra::grid.arrange(p1, p2) -->


<!-- # pct diff -->
<!-- p1 = vax_cases %>% -->
<!--   filter(County %in% c(top_5_counties)) %>% -->
<!--   # mutate(Vax_Category = ifelse(County %in% top_5_counties, 'Top_5', 'Bottom_5')) %>% -->
<!--   ggplot(aes(x = Date, y = Cases_14Day_MA_PCT, color = County, fill = County)) + -->
<!--   geom_line(size = 1) + -->
<!--   labs(y = 'Cases (14 Day MA) Percent Difference', -->
<!--        title = 'COVID Cases by Vaccination Rate Outliers (Top 5)') + -->
<!--   # scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   # facet_wrap(~Vax_Category, scales = 'free', ncol = 1) + -->
<!--   theme_pubr() -->

<!-- p2 = vax_cases %>% -->
<!--   filter(County %in% c(bottom_5_counties)) %>% -->
<!--   # mutate(Vax_Category = ifelse(County %in% top_5_counties, 'Top_5', 'Bottom_5')) %>% -->
<!--   ggplot(aes(x = Date, y = Cases_14Day_MA_PCT, color = County, fill = County)) + -->
<!--   geom_line(size = 1)+ -->
<!--   labs(y = 'Cases (14 Day MA) Percent Difference', -->
<!--        title = 'COVID Cases by Vaccination Rate Outliers (Bottom 5)') + -->
<!--   # scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   # facet_wrap(~Vax_Category, scales = 'free', ncol = 1) + -->
<!--   theme_pubr() -->
<!-- gridExtra::grid.arrange(p1, p2) -->



<!-- # pops -->
<!-- vax_cases %>% -->
<!--   select(Date, County, Population_16, Vaccination_Rate) %>% -->
<!--   na.omit() %>% -->
<!--   filter(Date == max(Date)) %>% -->
<!--   select(-Date) %>% -->
<!--   distinct() %>% -->
<!--   filter(County %in% c(top_5_counties, bottom_5_counties)) %>% -->
<!--   mutate(Vax_Category = ifelse(County %in% top_5_counties, 'Top_5', 'Bottom_5')) %>% -->
<!--   # group_by(County, Vax_Category) %>% -->
<!--   # summarize(Population_16 = max(Population_16)) %>% -->
<!--   arrange(Vaccination_Rate) -->


<!-- ``` -->

<!-- #### hosp -->

<!-- ```{r} -->
<!-- p1 = vax_hospitalizations %>% -->
<!--   filter(TSA %in% c(top_5_tsa)) %>% -->
<!--   # mutate(Vax_Category = ifelse(County %in% top_5_counties, 'Top_5', 'Bottom_5')) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Hosp_100K_16_14Day_MA, color = TSA, fill = TSA)) + -->
<!--   geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'Hosp Per 100K (14 Day MA)', -->
<!--        title = 'Hospitalizations by Vaccination Rate Outliers (Top 5)', -->
<!--        subtitle = 'COVID Hospitalizations adjusted per 100k population > 16 years old') + -->
<!--   # scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   # facet_wrap(~Vax_Category, scales = 'free', ncol = 1) + -->
<!--   theme_pubr() -->

<!-- p2 = vax_hospitalizations %>% -->
<!--   filter(TSA %in% c(bottom_5_tsa)) %>% -->
<!--   # mutate(Vax_Category = ifelse(County %in% top_5_counties, 'Top_5', 'Bottom_5')) %>% -->
<!--   na.omit() %>% -->
<!--   ggplot(aes(x = Date, y = Hosp_100K_16_14Day_MA, color = TSA, fill = TSA)) + -->
<!--   geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'Hosp Per 100K (14 Day MA)', -->
<!--        title = 'Hospitalizations by Vaccination Rate Outliers (Bottom 5)', -->
<!--        subtitle = 'COVID Hospitalizations adjusted per 100k population > 16 years old') + -->
<!--   # scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   # facet_wrap(~Vax_Category, scales = 'free', ncol = 1) + -->
<!--   theme_pubr() -->


<!-- gridExtra::grid.arrange(p1, p2) -->


<!-- # pct diff -->
<!-- p1 = vax_hospitalizations %>% -->
<!--   filter(TSA %in% c(top_5_tsa)) %>% -->
<!--   # mutate(Vax_Category = ifelse(County %in% top_5_counties, 'Top_5', 'Bottom_5')) %>% -->
<!--   ggplot(aes(x = Date, y = Hosp_14Day_MA_PCT, color = TSA, fill = TSA)) + -->
<!--   geom_line(size = 1) + -->
<!--   # geom_smooth(a'lpha = 0.5) + -->
<!--   labs(y = 'Hosp (14 Day MA) Percent Difference', -->
<!--        title = 'Hospitalizations by Vaccination Rate Outliers (Top 5)') + -->
<!--   # scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   # facet_wrap(~Vax_Category, scales = 'free', ncol = 1) + -->
<!--   theme_pubr() -->

<!-- p2 = vax_hospitalizations %>% -->
<!--   filter(TSA %in% c(bottom_5_tsa)) %>% -->
<!--   # mutate(Vax_Category = ifelse(County %in% top_5_counties, 'Top_5', 'Bottom_5')) %>% -->
<!--   ggplot(aes(x = Date, y = Hosp_14Day_MA_PCT, color = TSA, fill = TSA)) + -->
<!--   geom_line(size = 1) + -->
<!--   # geom_smooth(alpha = 0.5) + -->
<!--   labs(y = 'Hosp (14 Day MA) Percent Difference', -->
<!--        title = 'Hospitalizations by Vaccination Rate Outliers (Bottom 5)') + -->
<!--   # scale_color_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   # scale_fill_brewer('Vaccination Quartile', palette = 'RdBu') + -->
<!--   scale_x_date(date_breaks = '2 weeks', date_labels = '%b %d') + -->
<!--   # facet_wrap(~Vax_Category, scales = 'free', ncol = 1) + -->
<!--   theme_pubr() -->


<!-- gridExtra::grid.arrange(p1, p2) -->





<!-- # pops -->
<!-- vax_hospitalizations %>% -->
<!--   select(Date, TSA, Population_16, Vaccination_Rate) %>% -->
<!--   na.omit() %>% -->
<!--   filter(Date == max(Date)) %>% -->
<!--   select(-Date) %>% -->
<!--   distinct() %>% -->
<!--   filter(TSA %in% c(top_5_tsa, bottom_5_tsa)) %>% -->
<!--   mutate(Vax_Category = ifelse(TSA %in% top_5_tsa, 'Top_5', 'Bottom_5')) %>% -->
<!--   # group_by(County, Vax_Category) %>% -->
<!--   # summarize(Population_16 = max(Population_16)) %>% -->
<!--   arrange(Vaccination_Rate) -->


<!-- ``` -->

<!-- # Animation -->

<!-- ```{r} -->
<!-- library(gganimate) -->
<!-- # library(gifski) -->
<!-- p = ggplot( -->
<!--   vax_cases %>% -->
<!--     left_join(county_classifications %>% select(County, PHR_Combined)) %>% -->
<!--     select(Date, County, Vaccination_Rate, Cases_100K_16_14Day_MA, Population_16, PHR_Combined) %>% -->
<!--     na.omit() %>% -->
<!--     filter(Cases_100K_16_14Day_MA > 0), -->
<!--   aes(x = Cases_100K_16_14Day_MA, y = Vaccination_Rate, size = Population_16, color = PHR_Combined)) + -->
<!--   geom_point() + -->
<!--   # geom_text(aes(label = County), color = 'black') + -->
<!--   scale_size('Population Over 16', range = c(8, 15)) + -->
<!--   scale_x_log10() + -->
<!--   scale_color_viridis_d('') + -->
<!--   guides(color = guide_legend(override.aes = list(size=8))) + -->
<!--   labs(x = "COVID-19 Cases Per 100K Over 16 (log)", y = "Vaccination Rate") + -->
<!--   theme_pubr() + -->
<!--   theme(legend.position = 'right') -->

<!-- p_anim = p + transition_time(Date) + -->
<!--   labs(title = 'Date: {frame_time}') + -->
<!--   theme(plot.title = element_text(size = 24), -->
<!--         axis.text.x = element_text(size = 20), -->
<!--         axis.text.y = element_text(size = 20), -->
<!--         axis.title.x = element_text(size = 24), -->
<!--         axis.title.y = element_text(size = 24), -->
<!--         legend.text = element_text(size = 20), -->
<!--         legend.title = element_text(size = 20)) -->
<!-- animate(p_anim, duration = 15, width = 1200, height = 800, renderer = ffmpeg_renderer()) -->
<!-- anim_save('C:/Users/jeffb/Desktop/Life/personal-projects/COVID/diagnostics/animation.mp4') -->
<!-- ``` -->

